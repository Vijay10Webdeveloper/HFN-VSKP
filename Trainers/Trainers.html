<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meditation Session Attendance Management</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- ADD SUPABASE: -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  
  <style>
    /* --- styles (kept similar to your previous look & feel) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --text-dark: #333;
      --border-radius: 12px;
      --primary-color: #2c3e50;
      --secondary-color: #e74c3c;
      --accent-color: #f39c12;
      --light-bg: #ecf0f1;
      --dark-bg: #34495e;
      --text-color: #2c3e50;
      --light-text: #7f8c8d;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Header Styles */
    .header-section {
      background: var(--white);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative; /* added so absolute mobile nav positions relative to this */
    }

    .logo {
      height: 50px;
      transition: var(--transition);
    }

    .logo:hover { transform: scale(1.05); }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 2rem;
    }

    .nav-menu a {
      text-decoration: none;
      color: var(--text-color);
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
      position: relative;
    }

    .nav-menu a:hover,
    .nav-menu a.active {
      background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
      color: var(--white);
      transform: translateY(-2px);
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.6rem;
      color: var(--text-color);
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .menu-toggle:focus { outline: 2px solid rgba(44,62,80,0.12); }

    .login-container { max-width:500px; margin:10% auto; background: rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,0.1); padding:40px; text-align:center; }
    .login-header { background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:white; padding:30px; margin:-40px -40px 30px -40px; border-radius:15px 15px 0 0; }
    .login-header h1 { font-size:2em; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
    .login-form { display:flex; flex-direction:column; gap:20px; }
    .login-input { padding:15px; border:2px solid #ddd; border-radius:8px; font-size:16px; transition:border-color .3s; }
    .login-input:focus { outline:none; border-color:#3498db; box-shadow:0 0 10px rgba(52,152,219,0.1); }
    .login-btn { background: linear-gradient(135deg,#3498db 0%,#2980b9 100%); color:white; padding:15px 30px; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold; transition:all .3s; }
    .login-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(52,152,219,.3); }
    .login-error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; padding:15px; border-radius:8px; margin-top:15px; font-weight:bold; display:none; text-align:left; white-space:pre-wrap; }
    .login-info { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; padding:15px; border-radius:8px; margin-bottom:20px; font-size:14px; line-height:1.5; text-align:left; }
    .main-app { display:none; }
    .main-app.authenticated { display:block; }
    .container { max-width:1400px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
    .header { background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:white; padding:30px; text-align:center; position:relative; }
    .logout-btn { position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.3); padding:8px 15px; border-radius:5px; cursor:pointer; font-size:12px; transition:all .3s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .user-info { position:absolute; top:20px; left:20px; font-size:12px; opacity:0.85; }
    .header h1 { font-size:2.2em; margin-bottom:8px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
    .content { padding:30px; }
    .tabs { display:flex; margin-bottom:30px; border-bottom:2px solid #dee2e6; gap:10px; flex-wrap:wrap; }
    .tab { padding:12px 20px; background:#f8f9fa; border:1px solid #dee2e6; cursor:pointer; transition:all .2s; font-weight:bold; border-radius:6px; }
    .tab.active { background:#3498db; color:white; border-color:#3498db; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .section { background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px; border-left:5px solid #3498db; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .form-group label { font-weight:bold; color:#555; margin-bottom:6px; display:block; }
    .file-input-wrapper { position:relative; display:inline-block; cursor:pointer; background: linear-gradient(135deg,#9b59b6 0%,#8e44ad 100%); color:white; padding:10px 18px; border-radius:8px; font-weight:bold; }
    .btn { background: linear-gradient(135deg,#3498db 0%,#2980b9 100%); color:white; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:bold; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(52,152,219,0.2); }
    .btn-small { padding:8px 12px; font-size:13px; }
    .btn-success { background: linear-gradient(135deg,#27ae60 0%,#2ecc71 100%); }
    .btn-danger { background: linear-gradient(135deg,#e74c3c 0%,#c0392b 100%); }
    .btn-warning { background: linear-gradient(135deg,#f39c12 0%,#e67e22 100%); }
    .student-list { padding:12px 0; }
    .student-item { display:flex; justify-content:space-between; align-items:center; padding:12px; margin-bottom:8px; background:white; border-radius:8px; border:1px solid #eee; }
    .student-name { font-weight:bold; color:#2c3e50; }
    .student-id { color:#666; font-size:12px; }
    .attendance-badge { padding:5px 10px; border-radius:12px; color:white; font-weight:bold; font-size:12px; }
    .report-table { width:100%; border-collapse:collapse; background:white; }
    .report-table th, .report-table td { padding:10px 12px; border-bottom:1px solid #eee; text-align:left; }
    .data-preview { max-height:420px; overflow:auto; border:1px solid #dee2e6; border-radius:8px; background:white; padding:8px; }
    .alert { padding:12px; margin-bottom:12px; border-radius:8px; font-weight:bold; }
    .alert-success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
    .alert-error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
    .alert-info { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; }
    .chart-controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }

    /* Responsive Design: Mobile nav adjustments */
    @media (max-width: 768px) {
      .menu-toggle {
        display: block;
        z-index: 1200; /* ensure the toggle sits above the menu */
      }

      /* position the menu absolute under header-container so it aligns correctly regardless of header height */
      .nav-menu {
        position: absolute;
        top: 100%;               /* sits directly below the header container */
        left: -100%;
        width: 100%;
        height: auto;            /* let content determine height */
        background: var(--white);
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 1.25rem 1rem;
        transition: var(--transition);
        box-shadow: var(--shadow);
        gap: 1rem;
        z-index: 1100;
      }

      .nav-menu.active { left: 0; }

      /* make nav links full width and easy to tap */
      .nav-menu a {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        text-align: center;
        border-radius: 8px;
      }

      /* slightly reduce gap on very small screens */
      .nav-menu { gap: 0.75rem; }
    }

    /* Footer */
    .footer {
      background: var(--primary-color);
      color: white;
      padding: 2rem 0;
      text-align: center;
      margin-top: 3rem;
    }

    .container {
      background: var(--primary-color);
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .footer-links a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .footer-links a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    .footer a:hover {
      background: var(--secondary-color);
    }
  </style>
</head>
<body>
  <div>
 

  <!-- Login -->
  
     <!-- Header - Fixed Structure
  <header class="header-section">
    <div class="header-container">
      <img src="../Images/advancing-in-love-black.png" alt="Heartfulness" class="logo">
      <nav>
        <ul class="nav-menu" id="nav-menu">
          <li><a href="../Home/Home.html" class="active">HOME</a></li>
          <li><a href="../NewSeeker/Newseekers.html">NEW SEEKERS</a></li>
          <li><a href="../Abhyasi/Abhyasi.html">ABHYASIS</a></li>
          <li><a href="./Trainers.html">TRAINERS</a></li>
        </ul>  -->
        <!-- Accessible hamburger — no external icon dependency 
        <button class="menu-toggle" id="menu-toggle" aria-expanded="false" aria-controls="nav-menu" aria-label="Toggle navigation">☰</button>
      </nav>
    </div>
  </header> -->
<div id="loginScreen" class="login-container">
    <div class="login-header">
      <h1>🔐 Access Required</h1>
      <p>Meditation Session Attendance System</p>
    </div>

    <div class="login-info">
      <strong>Secure Access</strong><br>
      Enter authorized credentials to access the system.
    </div>

    <div class="login-form">
      <input id="emailInput" class="login-input" type="email" placeholder="Enter your email" onkeypress="handleLoginKeyPress(event)" />
      <div style="position:relative;">
        <input id="passwordInput" class="login-input" type="password" placeholder="Enter your password" onkeypress="handleLoginKeyPress(event)" />
        <button id="passwordToggle" onclick="togglePasswordVisibility()" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer;">👁️</button>
      </div>
      <button class="login-btn" onclick="authenticateUser()">🚪 Login to System</button>
    </div>

    <div id="loginError" class="login-error"></div>

    <footer class="footer">
    <div class="container">
      <div class="footer-links">
        <a href="../Home/Home.html">
          <i class="fas fa-envelope"></i> Home
        </a>
        <a href="../HFNContactUs/HFNContactUs.html">
          <i class="fas fa-envelope"></i> Contact Us
        </a>
        <a href="../FAQs/FAQs.html">
          <i class="fas fa-question-circle"></i> FAQs
        </a>
      </div>
      <div class="footer-message">
        <p>Experience the peace and transformation that comes with regular Heartfulness meditation practice. Contact us today to begin your journey.</p>
      </div>
      <div class="footer-copyright">
        <p style="text-align: center" >&copy; 2024 Heartfulness Meditation Vizag. All rights reserved.</p>
      </div>
    </div>
  </footer>
  </div>
</div>  


  <!-- Main App -->
  <div id="mainApp" class="main-app">
    <div class="container">
      <div class="header">
        <div class="user-info" id="userInfo">👤 Logged in as: <span id="currentUser"></span></div>
        <button class="logout-btn" onclick="logout()">🚪 Logout</button>
        <h1>🧘 Meditation Session Attendance Management</h1>
        <p>Attendance tracking with in-browser master record storage</p>
      </div>

      <div class="content">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('attendance')">📋 Mark Attendance</div>
          <div class="tab" onclick="switchTab('records')">📂 View All Records</div>
          <div class="tab" onclick="switchTab('import')">📥 Import Data</div>
          <div class="tab" onclick="switchTab('reports')">📊 Generate Reports</div>
        </div>

        <div id="alertContainer"></div>

        <!-- Attendance -->
        <div id="attendance-tab" class="tab-content active">
          <div class="section">
            <h2>👥 Manage Abhyasis</h2>
           <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap;">
                <input id="studentName" type="text" placeholder="Enter Abhyasi name" style="padding:10px; border-radius:6px; border:1px solid #ddd; flex:1;" />
                <input id="studentId" type="text" placeholder="Enter Abhyasi ID" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100px;" />
                <input id="studentContact" type="text" placeholder="Enter Contact number" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100px;" />
                <input id="studentDateOfJoining" type="date" placeholder="Date of Joining" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:140px;" />
                <button class="btn btn-small" onclick="addAbhyasi()">Add Abhyasi</button>
                <button class="btn btn-success" onclick="saveAbhyasisToCloud()" style="margin-left:auto;">💾 Save to Cloud</button>
                <button class="btn" onclick="downloadAbhyasiDetailsExcel()" style="margin-left:4px;">⬇️ Download Abhyasis</button>
            </div>
          <div id="studentsList" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:8px; background:white;"></div>
          </div>

          <div class="section">
            <h2>📋 Session Information</h2>
            <div class="form-grid">
              <div>
                <label for="sessionName">Session Name</label>
                <select id="sessionName" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100%;">
                  <option value="Sunday">Sunday</option>
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                  <option value="Saturday">Saturday</option>
                </select>
              </div>
              <div>
                <label for="sessionType">Session Type</label>
                <select id="sessionType" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100%;">
                  <option value="Group meditation session">Group meditation session</option>
                  <option value="Face to face individual sittings">Face to face individual sittings</option>
                </select>
              </div>
              <div>
                <label for="trainer">Trainer</label>
                <input id="trainer" type="text" placeholder="Trainer name" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100%;" />
              </div>
              <div>
                <label for="classDate">Date</label>
                <input id="classDate" type="date" onchange="updateCurrentDate()" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100%;" />
              </div>
            </div>
          </div>
          <div class="container">
             <div class="section attendance-section">
               <div style="background:linear-gradient(135deg,#8e44ad 0%,#9b59b6 100%); color:white; padding:12px; border-radius:8px;">
                    <h3 style="margin:0;">✅ Today's Attendance</h3>
               </div>
                  <div style="padding:12px;">
                  <strong id="currentDate"></strong>
                  </div>
               <div class="student-list" id="attendanceList" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:8px; background:white; margin-bottom:12px;"></div>
               <div style="text-align:center; padding:16px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                   <button class="btn btn-success" onclick="saveAttendance()">💾 Save Today's Attendance</button>
                   <button class="btn btn-warning" onclick="updateAttendance()">🔄 Update Today's Attendance</button>
                   <button class="btn" onclick="resetAttendanceForm()">↺ Reset Form</button>
              </div>

             </div>
           </div>
        </div>

        <!-- Records -->
       <!-- In the "View All Records" tab -->
<div id="records-tab" class="tab-content">
  <div class="section">
    <h2>📂 All Attendance Records (Master)</h2>

    <div style="margin-bottom:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button class="btn btn-success" onclick="showRecords()">📋 Show All Records</button>
      <button class="btn" onclick="downloadMasterCSV()">⬇️ Download CSV</button>
      <button class="btn" onclick="downloadMasterExcel()">⬇️ Download Excel</button>
      
      <!-- THIS BUTTON CALLS THE FUNCTION -->
      <button class="btn btn-warning" onclick="cleanupStaleRecords()">🧹 Clean Up Stale Records</button>
      
      <button class="btn btn-danger" onclick="clearMasterRecords()">🗑️ Clear Master Records</button>
      
      <label style="margin-left:auto; display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="mr-select-all" onchange="toggleSelectAll(this.checked)" />
        <span>Select All</span>
      </label>
      <button class="btn btn-danger" id="mr-delete-selected-btn" onclick="deleteSelectedMaster()" disabled>
        🗑️ Delete Selected
      </button>
    </div>

    <div id="allRecordsContainer" class="data-preview"></div>
  </div>
</div>
        <!-- Import -->
<div id="import-tab" class="tab-content">
  <div class="section">
    <h2>📥 Import Attendance Data</h2>
    <p style="color:#666;">Supported formats: CSV and Excel (XLSX, XLS)</p>
    <p style="color:#666;">Preferred header (exported by this app):</p>
    <pre style="background:#fff;padding:8px;border-radius:6px;color:#333;">Date,Day of Week,Abhyasi Name,Abhyasi ID,Session Name,Trainer,Present,Month,Year</pre>
    <p style="color:#666;">This importer tolerates simpler files (e.g. Date,Abhyasi Name,Abhyasi ID,Session Name,Trainer,Present).</p>

    <div style="margin-bottom:12px;">
      <label class="file-input-wrapper">
        📂 Choose CSV or Excel File
        <input id="csvFileInput" type="file" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleFileSelect(event)" />
      </label>
    </div>

    <div id="importPreview" style="display:none;">
      <h3>Import Preview</h3>
      <p id="importSummary"></p>
      <div style="max-height:320px; overflow:auto; border:1px solid #eee; padding:8px; background:white;">
  <table class="report-table" id="importPreviewTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Day</th>
        <th>Name</th>
        <th>ID</th>
        <th>Session</th>
        <th>Type</th>
        <th>Trainer</th>
        <th>Present</th>
      </tr>
    </thead>
    <tbody id="importPreviewBody"></tbody>
  </table>
</div>
      <div style="margin-top:12px;">
        <button class="btn btn-success" onclick="confirmImport()">✅ Import Data</button>
        <button class="btn" onclick="cancelImport()">❌ Cancel</button>
      </div>
    </div>
  </div>
</div>

        <!-- Reports -->
  
<div id="reports-tab" class="tab-content">
  <div class="section">
    <h2>📊 Generate Reports</h2>

    <!-- Range selector: Month or Date range -->
   
<!-- ADD THIS SECTION -->
<div style="margin-bottom:16px;">
  <label style="font-weight:bold; margin-bottom:8px; display:block;">Select Range Type:</label>
  <label style="margin-right:20px;">
    <input type="radio" name="rangeMode" value="month" checked onchange="onRangeModeChange()" />
    Month Range
  </label>
  <label>
    <input type="radio" name="rangeMode" value="date" onchange="onRangeModeChange()" />
    Date Range
  </label>
</div>

  <!-- rest of your existing form-grid content -->

    <div class="form-grid" style="align-items:end;">
      <div id="monthRangeGroup">
        <label for="startMonth">Start Month</label>
        <input id="startMonth" type="month" style="padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;" />
      </div>
      <div id="endMonthGroup">
        <label for="endMonth">End Month</label>
        <input id="endMonth" type="month" style="padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;" />
      </div>

      <div id="dateRangeGroup" style="display:none;">
        <label for="startDate">Start Date</label>
        <input id="startDate" type="date" style="padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;" />
      </div>
      <div id="dateRangeGroup2" style="display:none;">
        <label for="endDate">End Date</label>
        <input id="endDate" type="date" style="padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;" />
      </div>

      <div>
        <label for="reportType">Report Type</label>
        <select id="reportType" style="padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;">
          <option value="monthly">Monthly Summary</option>
          <option value="detailed">Detailed Records</option>
          <option value="student">Individual Abhyasi</option>
        </select>
      </div>
      <div id="studentSelectGroup" style="display:none;">
        <label for="reportStudent">Select Abhyasi</label>
        <select id="reportStudent" style="padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;"></select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <button class="btn" onclick="generateReport()">📊 Generate Report</button>
    </div>
<div class="chart-controls" style="margin-top:16px;">
  <!-- SESSION FILTERS -->
  <button class="btn" onclick="showComprehensiveAnalysis()">📊 Comprehensive Analysis</button>
</div>
    <div id="reportResults" style="display:none; margin-top:12px;"></div>
  </div>
</div>


  <script>
    /***** AUTH & APP STATE *****/
    const AUTHORIZED_USERS = {
      'admin@sundayclass.com': { password: 'aDMin890', name: 'System Administrator', role: 'Admin' },
      'mvijay108@gmail.com': { password: 'mycall10', name: 'Trainer', role: 'Trainer' },
      };

    const PASSWORD_SETTINGS = { minLength: 6, maxAttempts: 3, lockoutTime: 15 };
    let failedAttempts = {};
    let lockedUsers = {};
    let currentUser = null;
    let isAuthenticated = false;

    // App data
    let abhyasis = []; // { name, id, contact }
    let attendanceHistory = {}; // date -> array of records
    let masterRecords = []; // persisted to localStorage
    const MASTER_KEY = 'meditation_master_records_v1';
    const APP_DATA_KEY = 'meditation_app_data_v1';

    // DOM init
    document.addEventListener('DOMContentLoaded', () => {
      // set defaults
      document.getElementById('classDate').valueAsDate = new Date();
      const now = new Date();
      const thisMonth = now.toISOString().slice(0,7);
      document.getElementById('startMonth').value = thisMonth;
      document.getElementById('endMonth').value = thisMonth;
      document.getElementById('startDate').valueAsDate = new Date();
      document.getElementById('endDate').valueAsDate = new Date();
      updateCurrentDate();

      loadFailedAttempts();
      checkStoredAuthentication();
      loadSavedData();
      loadMasterRecords();
      updateStudentsList();
      updateAttendanceList();

      // Mobile nav: update ARIA expanded state when menu toggles
      const menuToggle = document.getElementById('menu-toggle');
      const navMenu = document.getElementById('nav-menu');
      if (menuToggle && navMenu) {
        menuToggle.addEventListener('click', () => {
          const expanded = navMenu.classList.contains('active');
          menuToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        });
      }
    });
// Always return YYYY-MM-DD no matter the browser/timezone
function getNormalizedDateFromInput(inputId) {
  const input = document.getElementById(inputId);
  // Prefer valueAsDate when available
  if (input && input.valueAsDate instanceof Date && !isNaN(input.valueAsDate)) {
    const d = new Date(Date.UTC(
      input.valueAsDate.getFullYear(),
      input.valueAsDate.getMonth(),
      input.valueAsDate.getDate()
    ));
    return d.toISOString().slice(0, 10);
  }
  // Fallback to raw value (assumed YYYY-MM-DD)
  const raw = input?.value?.trim();
  if (raw && /^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
  return ''; // not set
}

    function togglePasswordVisibility() {
      const pw = document.getElementById('passwordInput');
      const btn = document.getElementById('passwordToggle');
      if (pw.type === 'password') { pw.type = 'text'; btn.textContent = '🙈'; }
      else { pw.type = 'password'; btn.textContent = '👁️'; }
    }

    function handleLoginKeyPress(e) { if (e.key === 'Enter') authenticateUser(); }

   async function authenticateUser() {
  const email = document.getElementById('emailInput').value.trim().toLowerCase();
  const password = document.getElementById('passwordInput').value;
  const loginError = document.getElementById('loginError');
  loginError.style.display = 'none'; loginError.textContent = '';

  if (!email) return showLoginError('Please enter an email address.');
  if (!password) return showLoginError('Please enter your password.');
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showLoginError('Please enter a valid email address.');

  if (!AUTHORIZED_USERS[email]) { recordFailedAttempt(email); return showLoginError(`❌ Access Denied: Email "${email}" is not authorized.`); }

  if (AUTHORIZED_USERS[email].password !== password) {
    recordFailedAttempt(email);
    const attempts = failedAttempts[email] || 0;
    const remaining = PASSWORD_SETTINGS.maxAttempts - attempts;
    if (remaining > 0) return showLoginError(`❌ Incorrect password for "${email}". ${remaining} attempts remaining.`);
    else return showLoginError(`🔒 Account locked for ${PASSWORD_SETTINGS.lockoutTime} minutes.`);
  }

  // after successful login
   clearFailedAttempts(email);
   currentUser = email; isAuthenticated = true;
   localStorage.setItem('authenticatedUser', email);
   localStorage.setItem('authTime', new Date().toISOString());
   await verifyAbhyasisDataOnLogin();  // CHANGED: Load abhyasis with joining dates
   showMainApp();
}

    function checkStoredAuthentication() {
      try {
        const storedUser = localStorage.getItem('authenticatedUser');
        const time = localStorage.getItem('authTime');
        if (storedUser && time && AUTHORIZED_USERS[storedUser]) {
          const hoursDiff = (new Date() - new Date(time)) / (1000*60*60);
          if (hoursDiff < 24) {
            currentUser = storedUser; isAuthenticated = true;
            showMainApp();
            return;
          }
        }
      } catch (err) { console.error(err); }
      showLoginScreen();
    }

    function recordFailedAttempt(email) {
      if (!failedAttempts[email]) failedAttempts[email] = 0;
      failedAttempts[email]++;
      if (failedAttempts[email] >= PASSWORD_SETTINGS.maxAttempts) {
        lockedUsers[email] = new Date().getTime() + PASSWORD_SETTINGS.lockoutTime * 60 * 1000;
      }
      localStorage.setItem('failedAttempts', JSON.stringify(failedAttempts));
      localStorage.setItem('lockedUsers', JSON.stringify(lockedUsers));
      console.warn('Failed login', email);
    }

    function loadFailedAttempts() {
      try {
        const fa = localStorage.getItem('failedAttempts');
        const lu = localStorage.getItem('lockedUsers');
        if (fa) failedAttempts = JSON.parse(fa);
        if (lu) lockedUsers = JSON.parse(lu);
      } catch (err) { failedAttempts = {}; lockedUsers = {}; }
    }

    function clearFailedAttempts(email) {
      delete failedAttempts[email]; delete lockedUsers[email];
      localStorage.setItem('failedAttempts', JSON.stringify(failedAttempts));
      localStorage.setItem('lockedUsers', JSON.stringify(lockedUsers));
    }

    function showLoginError(msg) {
      const div = document.getElementById('loginError');
      div.textContent = msg;
      div.style.display = 'block';
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordInput').focus();
    }

    function showMainApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').classList.add('authenticated');
      const info = AUTHORIZED_USERS[currentUser];
      document.getElementById('currentUser').textContent = `${info.name} (${info.role})`;
      updateStudentsList();
      updateAttendanceList();
      displayAllRecords();
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainApp').classList.remove('authenticated');
    }

    function logout() {
      if (!confirm('Are you sure you want to logout?')) return;
      currentUser = null; isAuthenticated = false;
      localStorage.removeItem('authenticatedUser');
      localStorage.removeItem('authTime');
      showLoginScreen();
    }

    /***** ABHYASIS MANAGEMENT (consistent) *****/
// ============ CHANGE 1: Update the abhyasis object structure ============
// In the addAbhyasi() function, change it to include dateOfJoining:

function addAbhyasi() {
  const name = document.getElementById('studentName').value.trim();
  const id = document.getElementById('studentId').value.trim();
  const contact = document.getElementById('studentContact').value.trim();
  const dateOfJoining = document.getElementById('studentDateOfJoining').value; // NEW LINE
  
  if (!name || !id) { showAlert('Please enter Abhyasi name and ID', 'error'); return; }
  if (abhyasis.find(a => a.id === id)) { showAlert('Abhyasi ID already exists', 'error'); return; }
  
  abhyasis.push({ name, id, contact, dateOfJoining }); // UPDATED
  
  document.getElementById('studentName').value = '';
  document.getElementById('studentId').value = '';
  document.getElementById('studentContact').value = '';
  document.getElementById('studentDateOfJoining').value = ''; // NEW LINE
  
  updateStudentsList();
  updateAttendanceList();
  saveDataLocal();
  showAlert(`Abhyasi "${name}" added (unsaved to cloud)`, 'success');
}

// ============ CHANGE 2: Update editAbhyasi() ============
function editAbhyasi(index) {
  const a = abhyasis[index];
  const container = document.getElementById(`student-${index}`);
  if (!container) return;
  container.innerHTML = `
    <div style="flex:1; display:flex; gap:8px; flex-wrap:wrap;">
      <input id="editName-${index}" value="${a.name}" style="padding:6px; flex:1;" />
      <input id="editId-${index}" value="${a.id}" style="padding:6px; width:120px;" />
      <input id="editContact-${index}" value="${a.contact || ''}" style="padding:6px; width:160px;" />
      <input id="editDateOfJoining-${index}" type="date" value="${a.dateOfJoining || ''}" style="padding:6px; width:160px;" />
    </div>
    <div style="display:flex; gap:6px;">
      <button class="btn btn-success btn-small" onclick="saveEditAbhyasi(${index})">Save</button>
      <button class="btn btn-warning btn-small" onclick="updateStudentsList()">Cancel</button>
    </div>
  `;
}

// ============ CHANGE 3: Update saveEditAbhyasi() ============
function saveEditAbhyasi(index) {
  const name = document.getElementById(`editName-${index}`).value.trim();
  const id = document.getElementById(`editId-${index}`).value.trim();
  const contact = document.getElementById(`editContact-${index}`).value.trim();
  const dateOfJoining = document.getElementById(`editDateOfJoining-${index}`).value; // NEW LINE
  
  if (!name || !id) { showAlert('Name & ID required', 'error'); return; }
  const duplicate = abhyasis.find((a,i) => a.id === id && i !== index);
  if (duplicate) { showAlert('Another Abhyasi with this ID exists', 'error'); return; }
  
  abhyasis[index] = { name, id, contact, dateOfJoining }; // UPDATED
  
  saveDataLocal();
  updateStudentsList();
  updateAttendanceList();
  showAlert('Abhyasi updated (unsaved to cloud)', 'success');
}

// ============ CHANGE 4: Update updateStudentsList() ============
function updateStudentsList() {
  const container = document.getElementById('studentsList');
  if (!abhyasis.length) {
    container.innerHTML = '<p style="color:#666; font-style:italic;">No Abhyasis yet.</p>';
    return;
  }
  container.innerHTML = abhyasis.map((a,i) => `
    <div class="student-item" id="student-${i}">
      <div>
        <div class="student-name">${escapeHtml(a.name)}</div>
        <div class="student-id">ID: ${escapeHtml(a.id)}${a.contact ? ' | ' + escapeHtml(a.contact) : ''}${a.dateOfJoining ? ' | Joined: ' + a.dateOfJoining : ''}</div>
      </div>
      <div style="display:flex; gap:6px;">
        <button class="btn btn-warning btn-small" onclick="editAbhyasi(${i})">Edit</button>
        <button class="btn btn-danger btn-small" onclick="removeAbhyasi(${i})">Remove</button>
      </div>
    </div>`).join('');
}

// ============ CHANGE 5: Add new download function ============
function downloadAbhyasiDetailsExcel() {
  if (!abhyasis.length) {
    showAlert('No abhyasis to download', 'error');
    return;
  }

  try {
    const data = [
      ['Abhyasi Name', 'Abhyasi ID', 'Contact Number', 'Date of Joining']
    ];
    
    abhyasis.forEach(a => {
      data.push([
        a.name,
        a.id,
        a.contact || '',
        a.dateOfJoining || ''
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Abhyasis');

    const filename = `abhyasi_details_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    showAlert('Abhyasi details exported successfully', 'success');
  } catch (err) {
    console.error('Export error:', err);
    showAlert('Failed to export: ' + err.message, 'error');
  }
}
    function removeAbhyasi(index) {
      const a = abhyasis[index];
      if (!confirm(`Remove ${a.name}?`)) return;
      abhyasis.splice(index,1);
      updateStudentsList(); updateAttendanceList(); saveDataLocal();
      showAlert(`Abhyasi "${a.name}" removed (unsaved to cloud)`, 'success');
    }

   

    /***** ATTENDANCE UI *****/
    function updateAttendanceList() {
  const container = document.getElementById('attendanceList');
  if (!abhyasis.length) { 
    container.innerHTML = '<p style="text-align:center;color:#666;">Add Abhyasis first to mark attendance.</p>'; 
    return; 
  }
  
  container.innerHTML = abhyasis.map((s,i) => `
    <div class="student-item" id="attendance-row-${i}">
      <div style="flex:1;">
        <div class="student-name">${escapeHtml(s.name)}</div>
        <div class="student-id">ID: ${escapeHtml(s.id)}</div>
      </div>
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="attendance-${i}" type="checkbox" />
        <span style="font-size:13px; color:#666;">Present</span>
      </label>
    </div>`).join('');

  // Load saved attendance for this date if exists
  loadTodayAttendance();
}


////////////05-10-2025//////////////////////////////////



function removeAttendanceRow(index) {
  const a = abhyasis[index];
  if (!confirm(`Remove ${a.name} from attendance list?\n\nNote: This will also remove them from the Abhyasis list.`)) return;
  
  abhyasis.splice(index, 1);
  updateAttendanceList();
  updateStudentsList();
  saveDataLocal();
  showAlert(`${a.name} removed from attendance (unsaved to cloud)`, 'success');
}

////////////////////////////////05-10-2025///////////////////////////////////////////////

    function updateCurrentDate() {
  const dateVal = document.getElementById('classDate').value;
  if (!dateVal) return;
  const d = new Date(dateVal);
  document.getElementById('currentDate').textContent = d.toLocaleDateString('en-US', { 
    weekday:'long', year:'numeric', month:'long', day:'numeric' 
  });
  
  // Load saved attendance for the selected date
  loadTodayAttendance();
}

    /***** SAVE ATTENDANCE & MASTER RECORDS *****/
    function loadMasterRecords() {
      try {
        const raw = localStorage.getItem(MASTER_KEY);
        masterRecords = raw ? JSON.parse(raw) : [];
      } catch (err) { console.error('Failed to load masterRecords', err); masterRecords = []; }
    }

    function saveMasterRecords() {
      try {
        localStorage.setItem(MASTER_KEY, JSON.stringify(masterRecords));
      } catch (err) { console.error('Failed to save masterRecords', err); }
    }

    function addNewRecordsToMaster(newRecords) {
      masterRecords = masterRecords.concat(newRecords);
      masterRecords = removeDuplicateRecords(masterRecords);
      saveMasterRecords();
    }
    /////////////////////////////////////Save attendance/////////////////////////
// REPLACE the saveAttendance() function in your code with this:
function saveAttendance() {
  if (!checkAuthentication()) return;

  // Get normalized date - use the same method as your code
  const date = getNormalizedDateFromInput('classDate');
  if (!date) {
    showAlert('Please select a valid date', 'error');
    return;
  }

  console.log('Saving attendance for date:', date);

  // Validate abhyasis
  if (!abhyasis || abhyasis.length === 0) {
    showAlert('No abhyasis added. Add abhyasis first.', 'error');
    return;
  }

  // Check if already saved for this date
  if (attendanceHistory && attendanceHistory[date]) {
    showAlert('Attendance already saved for this date. Use "Update" button to modify it.', 'info');
    return;
  }

  // Get session details
  const sessionName = document.getElementById('sessionName').value || 'Sunday';
  const trainer = document.getElementById('trainer').value || 'Not specified';
  const sessionType = document.getElementById('sessionType').value || '';

  // Build attendance records
  const attendanceData = [];
  abhyasis.forEach((s, i) => {
    const checkbox = document.getElementById(`attendance-${i}`);
    const isPresent = checkbox ? checkbox.checked : false;

    attendanceData.push({
      date: date,
      name: s.name,
      id: s.id,
      sessionName: sessionName,
      sessionType: sessionType,
      trainer: trainer,
      present: isPresent,
      savedBy: currentUser
    });
  });

  console.log('Created attendance records:', attendanceData.length);

  // Initialize if needed
  if (!attendanceHistory) {
    attendanceHistory = {};
  }

  // Save to local attendance history
  attendanceHistory[date] = attendanceData;

  // Add to master records (includes deduplication)
  addNewRecordsToMaster(attendanceData);
  
  // Persist everything
  saveData();
  
  // Reload to verify
  loadMasterRecords();
  displayAllRecords();

  console.log('Attendance saved. Total master records:', masterRecords.length);

  showAlert('✅ Attendance saved for ' + new Date(date).toLocaleDateString(), 'success');
}
    //////////////////////////////Update Attendance////////////////////////////

function updateAttendance() {
  if (!checkAuthentication()) return;

  const date = getNormalizedDateFromInput('classDate');
  if (!date) { showAlert('Please select a valid date', 'error'); return; }

  if (!abhyasis.length) { showAlert('No abhyasis to update', 'error'); return; }
  
  // Check if exists first
  if (!attendanceHistory[date]) {
    showAlert('No saved attendance for this date yet. Use "Save" button first.', 'error');
    return;
  }

  const sessionName = document.getElementById('sessionName').value || 'Sunday';
  const trainer = document.getElementById('trainer').value || 'Not specified';
  const sessionType = document.getElementById('sessionType').value || '';

  // Create updated records
  const updatedData = [];
  abhyasis.forEach((s,i) => {
    const checked = document.getElementById(`attendance-${i}`)?.checked ?? false;
    updatedData.push({
      date,
      name: s.name,
      id: s.id,
      sessionName,
      trainer,
      sessionType,
      present: !!checked,
      savedBy: currentUser
    });
  });

  // Remove old records for this date from master
  masterRecords = masterRecords.filter(r => r.date !== date);
  saveMasterRecords();

  // Update local history
  attendanceHistory[date] = updatedData;
  
  // Re-add updated records to master
  addNewRecordsToMaster(updatedData);
  saveData();
  loadMasterRecords();
  displayAllRecords();

  showAlert('✅ Attendance updated for ' + new Date(date).toLocaleDateString(), 'success');
}

////////////////////End of Update Attendance///////////////////////////////
/////////////////////Load Today Attendance///////////////////////////////
function loadTodayAttendance() {
  const date = getNormalizedDateFromInput('classDate');
  if (!date || !attendanceHistory[date]) {
    // Clear checkboxes if no saved attendance
    abhyasis.forEach((_,i) => {
      const cb = document.getElementById(`attendance-${i}`);
      if (cb) cb.checked = false;
    });
    return;
  }

  // Load previously saved attendance
  const records = attendanceHistory[date];
  abhyasis.forEach((a, i) => {
    const found = records.find(r => r.id === a.id);
    const cb = document.getElementById(`attendance-${i}`);
    if (cb) cb.checked = found ? found.present : false;
  });
}
///////////////////////////////////////////////////////////////////
function resetAttendanceForm() {
  abhyasis.forEach((_,i) => {
    const cb = document.getElementById(`attendance-${i}`);
    if (cb) cb.checked = false;
  });
  showAlert('Form cleared', 'info');
}
/////////////////////////////////////////////////////
    /***** DISPLAY / DOWNLOAD MASTER *****/
    function showRecords() {
  const container = document.getElementById('allRecordsContainer');
  if (!masterRecords.length) { 
    container.innerHTML = '<p style="color:#666; font-style:italic;">No master records stored yet.</p>'; 
    return; 
  }

  let html = `<table class="report-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>ID</th>
        <th>Session</th>
        <th>Session Type</th>
        <th>Trainer</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>`;
    
  masterRecords.forEach(r => {
    html += `<tr>
      <td>${r.date}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.id)}</td>
      <td>${escapeHtml(r.sessionName)}</td>
      <td style="font-size:12px; color:#666;">${escapeHtml(r.sessionType || 'N/A')}</td>
      <td>${escapeHtml(r.trainer)}</td>
      <td><span class="attendance-badge" style="background:${r.present ? '#27ae60' : '#e74c3c'}">${r.present ? 'Present' : 'Absent'}</span></td>
    </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
}
    // === Selection state for Master Records ===
let masterSelectedKeys = new Set();

function getRecordKey(r) {
  // Use same uniqueness as your dedupe to ensure 1:1 mapping
  // (date + id + sessionName). Adjust if you want stricter uniqueness.
  return `${r.date}__${r.id}__${r.sessionName || ''}`;
}

function refreshDeleteButtonState() {
  const btn = document.getElementById('mr-delete-selected-btn');
  if (btn) btn.disabled = masterSelectedKeys.size === 0;
}

function toggleSelectAll(checked) {
  const boxes = document.querySelectorAll('#allRecordsContainer input.mr-select');
  masterSelectedKeys.clear();
  boxes.forEach(cb => {
    cb.checked = checked;
    if (checked) masterSelectedKeys.add(cb.value);
  });
  refreshDeleteButtonState();
}

function onToggleRowSelect(cb) {
  if (cb.checked) masterSelectedKeys.add(cb.value);
  else masterSelectedKeys.delete(cb.value);
  // keep the global select-all in sync
  const selectAll = document.getElementById('mr-select-all');
  if (selectAll) {
    const boxes = document.querySelectorAll('#allRecordsContainer input.mr-select');
    const allChecked = boxes.length > 0 && Array.from(boxes).every(x => x.checked);
    selectAll.checked = allChecked;
    if (!cb.checked) selectAll.indeterminate = false;
    else if (!allChecked && masterSelectedKeys.size > 0) selectAll.indeterminate = true;
    else selectAll.indeterminate = false;
  }
  refreshDeleteButtonState();
}

function deleteSelectedMaster() {
  if (masterSelectedKeys.size === 0) return;
  const count = masterSelectedKeys.size;
  if (!confirm(`Delete ${count} selected record(s) from master? This cannot be undone.`)) return;

  const before = masterRecords.length;
  masterRecords = masterRecords.filter(r => !masterSelectedKeys.has(getRecordKey(r)));
  saveMasterRecords();

  // clear selection & UI
  masterSelectedKeys.clear();
  const selectAll = document.getElementById('mr-select-all');
  if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }
  displayAllRecords();
  refreshDeleteButtonState();

  showAlert(`Deleted ${before - masterRecords.length} record(s).`, 'success');

  // Optional: push to server if you use sync
  if (typeof syncToServer === 'function') {
    syncToServer().catch(() => {/* ignore */});
  }
}

///////////////////////////////////////////////////////////////////

function confirmImport() {
  if (!importData.length) return;
  const normalized = importData.map(r => ({
    date: r.date,
    name: r.name,
    id: r.id,
    sessionName: r.sessionName || '',
    sessionType: r.sessionType || '',  // ADD THIS LINE
    trainer: r.trainer || '',
    present: !!r.present
  }));

  addNewRecordsToMaster(normalized);
  const byDate = {};
  normalized.forEach(r => {
    if (!byDate[r.date]) byDate[r.date] = [];
    byDate[r.date].push(r);
  });
  Object.keys(byDate).forEach(d => attendanceHistory[d] = byDate[d]);
  saveData();
  updateStudentsFromImported(normalized);
  document.getElementById('importPreview').style.display = 'none';
  document.getElementById('csvFileInput').value = '';
  importData = [];
  displayAllRecords();
  showAlert('Imported records added to master', 'success');
}

/////////////////////////////////////////////////////////////////

// === REPLACE your existing displayAllRecords() with the version below ===
function displayAllRecords() {
  // Always reload fresh from localStorage to ensure latest data
  loadMasterRecords();

  const container = document.getElementById('allRecordsContainer');
  if (!masterRecords.length) {
    container.innerHTML = '<p style="color:#666; font-style:italic;">No master records stored yet.</p>';
    return;
  }

  const byDate = {};
  masterRecords.forEach(r => {
    if (!byDate[r.date]) byDate[r.date] = [];
    byDate[r.date].push(r);
  });
  const dates = Object.keys(byDate).sort().reverse();

  let html = `<div><strong>Total stored records:</strong> ${masterRecords.length} across ${dates.length} classes</div><br/>`;
  dates.forEach(date => {
    const recs = byDate[date];
    const presentCount = recs.filter(x => x.present).length;
    const sessionName = recs[0]?.sessionName || 'Session';
    const trainer = recs[0]?.trainer || 'Not specified';
    const sessionType = recs[0]?.sessionType || '';

    html += `
      <div style="border:1px solid #eee; padding:12px; margin-bottom:10px; border-radius:8px; background:white;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h3 style="margin:0;">${new Date(date).toLocaleDateString()}</h3>
            <div style="color:#666;">${escapeHtml(sessionName)}${sessionType ? ' | ' + escapeHtml(sessionType) : ''} | Trainer: ${escapeHtml(trainer)} | Present: ${presentCount}/${recs.length}</div>
          </div>
        </div>
        <div style="margin-top:8px; overflow:auto;">
          <table class="report-table">
            <thead><tr><th style="width:40px;">Select</th><th>#</th><th>Name</th><th>ID</th><th>Session Type</th><th>Status</th></tr></thead>
            <tbody>
              ${recs.map((r,i) => {
                const key = getRecordKey(r);
                return `
                <tr>
                  <td><input type="checkbox" class="mr-select" value="${key}" onchange="onToggleRowSelect(this)" /></td>
                  <td>${i+1}</td>
                  <td>${escapeHtml(r.name)}</td>
                  <td>${escapeHtml(r.id)}</td>
                  <td style="font-size:12px; color:#666;">${escapeHtml(r.sessionType || 'N/A')}</td>
                  <td><span class="attendance-badge" style="background:${r.present ? '#27ae60' : '#e74c3c'}">${r.present ? 'Present' : 'Absent'}</span></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  });

  container.innerHTML = html;
  
  // Clear selection state after re-render
  masterSelectedKeys.clear();
  refreshDeleteButtonState();
}

   function downloadMasterExcel() {
  if (!masterRecords.length) {
    showAlert('No master records to download', 'error');
    return;
  }

  try {
    // Prepare data for Excel
    const data = [
      ['Date', 'Day of Week', 'Abhyasi Name', 'Abhyasi ID', 'Session Name', 'Session Type', 'Trainer', 'Present', 'Month', 'Year']
    ];
    
    masterRecords.forEach(record => {
      const dateObj = new Date(record.date);
      let day = '', month = '', year = '';
      if (!isNaN(dateObj.getTime())) {
        day = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
        month = dateObj.toLocaleDateString('en-US', { month: 'long' });
        year = dateObj.getFullYear();
      }
      
      data.push([
        record.date,
        day,
        record.name,
        record.id,
        record.sessionName || '',
        record.sessionType || '',
        record.trainer || '',
        record.present ? 'Yes' : 'No',
        month,
        year
      ]);
    });

    // Create workbook and worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Attendance');

    // Generate filename
    const filename = `meditation_attendance_master_${new Date().toISOString().slice(0,10)}.xlsx`;

    // Download
    XLSX.writeFile(wb, filename);
    showAlert('Excel file downloaded successfully', 'success');
    
  } catch (err) {
    console.error('Excel export error:', err);
    showAlert('Failed to export Excel file: ' + err.message, 'error');
  }
}


    function clearMasterRecords() {
      if (!confirm('Clear all master records? This cannot be undone.')) return;
      masterRecords = [];
      saveMasterRecords();
      displayAllRecords();
      showAlert('Master records cleared', 'success');
    }

    /***** IMPORT CSV HANDLING (keeps merging into masterRecords) *****/
    let importData = [];

    function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const fileName = file.name.toLowerCase();
  
  if (fileName.endsWith('.csv')) {
    // Handle CSV file
    const reader = new FileReader();
    reader.onload = function(ev) {
      parseImportCSV(ev.target.result);
    };
    reader.readAsText(file);
  } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
    // Handle Excel file
    const reader = new FileReader();
    reader.onload = function(ev) {
      parseImportExcel(ev.target.result);
    };
    reader.readAsArrayBuffer(file);
  } else {
    showAlert('Unsupported file format. Please select a CSV or Excel file.', 'error');
    e.target.value = '';
  }
}

    function parseCSVLineAdvanced(line) {
      const result = []; let cur = ''; let inQuotes = false;
      for (let i=0;i<line.length;i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else cur += ch;
      }
      result.push(cur);
      return result.map(s => s.replace(/^"|"$/g,'').trim());
    }

    function parseImportCSV(csvText) {
  const lines = csvText.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 1) { showAlert('CSV appears empty', 'error'); return; }

  const headerLine = lines[0].trim();
  const headers = parseCSVLineAdvanced(headerLine).map(h => h.toLowerCase().trim());
  const headerMap = {};
  headers.forEach((h, idx) => {
    const normalized = h.replace(/\s+/g,' ').trim();
    if (normalized === 'date') headerMap.date = idx;
    else if (normalized === 'day of week' || normalized === 'day') headerMap.day = idx;
    else if (normalized === 'abhyasi name' || normalized === 'student name' || normalized === 'name') headerMap.name = idx;
    else if (normalized === 'abhyasi id' || normalized === 'student id' || normalized === 'id') headerMap.id = idx;
    else if (normalized === 'session name' || normalized === 'class name' || normalized === 'class') headerMap.sessionName = idx;
    else if (normalized === 'session type' || normalized === 'type') headerMap.sessionType = idx;  // ADD THIS
    else if (normalized === 'trainer' || normalized === 'instructor') headerMap.trainer = idx;
    else if (normalized === 'present' || normalized === 'status') headerMap.present = idx;
  });

  let dataStartIndex = 1;
  if (headerMap.date === undefined || headerMap.name === undefined || headerMap.id === undefined) {
    const firstCols = parseCSVLineAdvanced(lines[0]);
    if (firstCols.length >= 3) dataStartIndex = 0;
    else {
      showAlert('CSV header not recognized. Expected at minimum: Date,Abhyasi Name,Abhyasi ID,...', 'error');
      return;
    }
  }

  importData = [];
  for (let i = dataStartIndex; i < lines.length; i++) {
    const cols = parseCSVLineAdvanced(lines[i]);
    if (!cols.length) continue;
    const get = idx => (typeof idx === 'number' && cols[idx] !== undefined) ? cols[idx].trim() : '';

    const rec = { date:'', day:'', name:'', id:'', sessionName:'', sessionType:'', trainer:'', present:false };

    if (dataStartIndex === 0) {
      rec.date = get(0);
      rec.name = get(1) || '';
      rec.id = get(2) || '';
      rec.sessionName = get(3) || '';
      rec.sessionType = get(4) || '';  // ADD THIS
      rec.trainer = get(5) || '';      // SHIFT FROM 4 to 5
      rec.present = ['yes','true','1','present'].includes((get(6) || '').toLowerCase());  // SHIFT FROM 5 to 6
    } else {
      rec.date = headerMap.date !== undefined ? get(headerMap.date) : get(0);
      rec.day = headerMap.day !== undefined ? get(headerMap.day) : '';
      rec.name = headerMap.name !== undefined ? get(headerMap.name) : get(1);
      rec.id = headerMap.id !== undefined ? get(headerMap.id) : get(2);
      rec.sessionName = headerMap.sessionName !== undefined ? get(headerMap.sessionName) : get(3);
      rec.sessionType = headerMap.sessionType !== undefined ? get(headerMap.sessionType) : get(4);  // ADD THIS
      rec.trainer = headerMap.trainer !== undefined ? get(headerMap.trainer) : get(5);  // SHIFT FROM 4 to 5
      const presentText = headerMap.present !== undefined ? get(headerMap.present) : (get(6) || '');  // SHIFT FROM 5 to 6
      rec.present = ['yes','true','1','present'].includes(String(presentText).toLowerCase());
    }

    Object.keys(rec).forEach(k => { if (typeof rec[k] === 'string') rec[k] = rec[k].replace(/^"|"$/g,'').trim(); });

    if (rec.date && rec.name && rec.id) importData.push(rec);
  }

  if (!importData.length) { showAlert('No valid records found in CSV', 'error'); return; }
  displayImportPreview();
}
//////////////////////////////////////////////////


function parseImportExcel(arrayBuffer) {
  try {
    // Read the workbook
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    
    // Get the first sheet
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];
    
    // Convert to JSON (array of arrays)
    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
    
    if (!data || data.length < 2) {
      showAlert('Excel file appears empty or has insufficient data', 'error');
      return;
    }
    
    // Convert to CSV-like format for processing
    const csvText = data.map(row => 
      row.map(cell => {
        // Handle dates that Excel stores as numbers
        if (typeof cell === 'number' && cell > 40000 && cell < 50000) {
          // Likely an Excel date serial number
          const excelDate = new Date((cell - 25569) * 86400 * 1000);
          return excelDate.toISOString().slice(0, 10);
        }
        // Escape quotes and commas for CSV format
        const str = String(cell || '').trim();
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      }).join(',')
    ).join('\n');
    
    // Use existing CSV parser
    parseImportCSV(csvText);
    
  } catch (err) {
    console.error('Excel parsing error:', err);
    showAlert('Failed to parse Excel file: ' + err.message, 'error');
  }
}

//////////////////////////////////////////////////////////////////
    function displayImportPreview() {
  document.getElementById('importPreview').style.display = 'block';
  document.getElementById('importSummary').textContent = `Found ${importData.length} records`;
  const body = document.getElementById('importPreviewBody');
  body.innerHTML = importData.slice(0,50).map(r => `<tr>
    <td>${r.date}</td>
    <td>${r.day || (r.date ? new Date(r.date).toLocaleDateString('en-US', { weekday:'long' }) : '')}</td>
    <td>${escapeHtml(r.name)}</td>
    <td>${escapeHtml(r.id)}</td>
    <td>${escapeHtml(r.sessionName)}</td>
    <td style="font-size:11px;">${escapeHtml(r.sessionType || 'N/A')}</td>
    <td>${escapeHtml(r.trainer)}</td>
    <td>${r.present ? 'Present' : 'Absent'}</td>
  </tr>`).join('');
}
    /***** REPORTS & CHARTS (range-based) *****/
    document.getElementById('reportType').addEventListener('change', function() {
      document.getElementById('studentSelectGroup').style.display = this.value === 'student' ? 'block' : 'none';
      if (this.value === 'student') updateStudentSelect();
    });

    function onRangeModeChange() {
      const mode = document.querySelector('input[name="rangeMode"]:checked').value;
      if (mode === 'month') {
        document.getElementById('monthRangeGroup').style.display = '';
        document.getElementById('endMonthGroup').style.display = '';
        document.getElementById('dateRangeGroup').style.display = 'none';
        document.getElementById('dateRangeGroup2').style.display = 'none';
      } else {
        document.getElementById('monthRangeGroup').style.display = 'none';
        document.getElementById('endMonthGroup').style.display = 'none';
        document.getElementById('dateRangeGroup').style.display = '';
        document.getElementById('dateRangeGroup2').style.display = '';
      }
    }

    function updateStudentSelect() {
      const sel = document.getElementById('reportStudent');
      sel.innerHTML = '<option value="">Select an Abhyasi</option>' + abhyasis.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
    }

    function generateReport() {
      const mode = document.querySelector('input[name="rangeMode"]:checked').value;
      let start, end;
      if (mode === 'month') {
        const sm = document.getElementById('startMonth').value;
        const em = document.getElementById('endMonth').value;
        if (!sm || !em) { showAlert('Please select both start and end month', 'error'); return; }
        start = sm + '-01';
        end = em + '-31';
        if (start > end) { showAlert('Start month must be <= end month', 'error'); return; }
      } else {
        const sd = document.getElementById('startDate').value;
        const ed = document.getElementById('endDate').value;
        if (!sd || !ed) { showAlert('Please select both start and end date', 'error'); return; }
        start = sd;
        end = ed;
        if (start > end) { showAlert('Start date must be <= end date', 'error'); return; }
      }

      const type = document.getElementById('reportType').value;
      const results = document.getElementById('reportResults');
      results.style.display = 'block';

      if (type === 'monthly') generateMonthlyReportRange(start, end, results);
      else if (type === 'detailed') generateDetailedReportRange(start, end, results);
      else if (type === 'student') {
        const sid = document.getElementById('reportStudent').value;
        if (!sid) { showAlert('Select Abhyasi', 'error'); return; }
        generateStudentReportRange(start, end, sid, results);
      }
    }

    function getDatesInRange(start, end) {
      const s = new Date(start), e = new Date(end);
      const arr = [];
      for (let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
        arr.push(new Date(d).toISOString().slice(0,10));
      }
      return arr;
    }

    function generateMonthlyReportRange(start, end, container) {
      const dates = Object.keys(attendanceHistory).filter(d => d >= start && d <= end).sort();
      if (!dates.length) { container.innerHTML = '<p style="color:#666;">No records found</p>'; return; }

      const totalClasses = dates.length;
      const studentSet = new Set();
      let totalAttendances = 0;
      const rows = [];

      dates.forEach(d => {
        const recs = attendanceHistory[d];
        const present = recs.filter(r => r.present).length;
        recs.forEach(r => studentSet.add(r.id));
        totalAttendances += present;
        rows.push({ date: d, present, total: recs.length, percent: Math.round(present / recs.length * 100) });
      });

      const avg = Math.round(totalAttendances / totalClasses);
      let html = `<div><h3>Summary (${start} → ${end})</h3><div>Total classes: ${totalClasses} | Unique Abhyasis: ${studentSet.size} | Avg attendance: ${avg}</div><table class="report-table"><thead><tr><th>Date</th><th>Present</th><th>Total</th><th>Attendance %</th></tr></thead><tbody>`;
      rows.forEach(r => html += `<tr><td>${new Date(r.date).toLocaleDateString()}</td><td>${r.present}</td><td>${r.total}</td><td>${r.percent}%</td></tr>`);
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function generateDetailedReportRange(start, end, container) {
      const dates = Object.keys(attendanceHistory).filter(d => d >= start && d <= end).sort();
      if (!dates.length) { container.innerHTML = '<p style="color:#666;">No records found</p>'; return; }
      let html = `<div><h3>Detailed Report (${start} → ${end})</h3>`;
      dates.forEach(date => {
        const recs = attendanceHistory[date];
        const present = recs.filter(r => r.present).length;
        const sess = recs[0]?.sessionName || 'Session';
        const tr = recs[0]?.trainer || 'Not specified';
        const stype = recs[0]?.sessionType || '';
        html += `<div style="margin-bottom:12px;"><h4>${new Date(date).toLocaleDateString()}</h4><div>${sess}${stype ? ' | ' + stype : ''} | ${tr} | Present: ${present}/${recs.length}</div>`;
        html += `<table class="report-table"><thead><tr><th>#</th><th>Name</th><th>ID</th><th>Status</th></tr></thead><tbody>`;
        recs.forEach((r,i) => html += `<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.id)}</td><td>${r.present ? 'Present' : 'Absent'}</td></tr>`);
        html += `</tbody></table></div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    // Individual Abhyasi report for arbitrary range with charts
    let currentChart = null;
    function generateStudentReportRange(start, end, studentId, container) {
      const records = [];
      Object.keys(attendanceHistory).forEach(date => {
        if (date >= start && date <= end) {
          const found = attendanceHistory[date].find(r => r.id === studentId);
          if (found) records.push(found);
        }
      });

      if (!records.length) { container.innerHTML = '<p style="color:#666;">No records found for this Abhyasi in selected range.</p>'; return; }

      const presentCount = records.filter(r => r.present).length;
      const rate = Math.round(presentCount / records.length * 100);
      const abhyasi = abhyasis.find(a => a.id === studentId);
      const name = abhyasi ? abhyasi.name : studentId;

      let html = `<div>
        <h3>👤 ${escapeHtml(name)} - ${start} → ${end}</h3>
        <div style="margin-bottom:12px;">Total classes: ${records.length} | Attended: ${presentCount} | Rate: ${rate}%</div>
        <div class="chart-controls">
          <label>Chart type:
            <select id="chartTypeSelect">
              <option value="bar">Bar</option>
              <option value="line">Line</option>
              <option value="pie">Pie</option>
            </select>
          </label>
          <label>Group by:
            <select id="chartGroupSelect">
              <option value="byDate">By Date (attendance)</option>
              <option value="bySession">By Session name</option>
            </select>
          </label>
          <button class="btn" id="renderChartBtn">Render Chart</button>
        </div>
        <div style="background:white; padding:12px; border-radius:8px;">
          <canvas id="studentChart" width="800" height="300"></canvas>
        </div>
      </div>`;

      container.innerHTML = html;

      document.getElementById('renderChartBtn').addEventListener('click', () => {
        const type = document.getElementById('chartTypeSelect').value;
        const group = document.getElementById('chartGroupSelect').value;
        renderStudentChart(records, type, group, studentId);
      });

      renderStudentChart(records, 'bar', 'byDate', studentId);
    }

    function renderStudentChart(records, type, group, studentId) {
      const ctx = document.getElementById('studentChart').getContext('2d');
      if (currentChart) { currentChart.destroy(); currentChart = null; }

      if (group === 'byDate') {
        const sorted = records.slice().sort((a,b) => a.date.localeCompare(b.date));
        const labels = sorted.map(r => new Date(r.date).toLocaleDateString());
        const data = sorted.map(r => r.present ? 1 : 0);
        const cfg = {
          type: type === 'pie' ? 'pie' : type,
          data: {
            labels,
            datasets: [{
              label: 'Presence (1=present,0=absent)',
              data,
              backgroundColor: type === 'pie' ? labels.map((_,i) => paletteColor(i)) : undefined,
              borderColor: type === 'pie' ? undefined : 'rgba(54, 162, 235, 0.8)',
              fill: false
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: type === 'pie' } },
            scales: type === 'pie' ? undefined : { y: { beginAtZero:true, ticks:{ stepSize:1 } } }
          }
        };
        currentChart = new Chart(ctx, cfg);
      } else {
        const groups = {};
        records.forEach(r => {
          const key = r.sessionName || 'Session';
          if (!groups[key]) groups[key] = { present:0, total:0 };
          groups[key].total++;
          if (r.present) groups[key].present++;
        });
        const labels = Object.keys(groups);
        const presentData = labels.map(l => groups[l].present);
        const cfg = {
          type: type === 'pie' ? 'pie' : type,
          data: {
            labels,
            datasets: [{ label: 'Present', data: presentData, backgroundColor: labels.map((_,i)=> paletteColor(i)) }]
          },
          options: { responsive:true, plugins: { legend:{ display: true } } }
        };
        currentChart = new Chart(ctx, cfg);
      }
    }

    function paletteColor(i) {
      const palette = ['#4dc9f6','#f67019','#f53794','#537bc4','#acc236','#166a8f','#00a950','#58595b','#8549ba'];
      return palette[i % palette.length];
    }


/////////////////////////////////////////////////////////////////////////////////////////////
/////////////17-Oct-2025///////////////////////////////////////////////////////////////
// ============ SESSION-BASED FILTERS (FIXED) ============

function showAbhyasisBySessionOnly(dayName, sessionType) {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = {
        name: r.name,
        id: r.id,
        contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A',
        sessions: new Set(),
        count: 0
      };
    }
    
    // Track each unique session type
    if (sessionType) {
      if (r.sessionType === sessionType) {
        attendanceMap[r.id].sessions.add(sessionType);
        attendanceMap[r.id].count++;
      }
    }
  });

  let filtered = [];
  
  if (sessionType === 'Face to face individual sittings' && !dayName) {
    // Face-to-face only (regardless of other sessions)
    filtered = Object.values(attendanceMap)
      .filter(a => a.sessions.has('Face to face individual sittings'))
      .map(a => ({ ...a, sessions: undefined }))
      .sort((a, b) => b.count - a.count);
    
    displaySessionResults(filtered, 'Face-to-Face Sessions Only', 
      ['Rank', 'Name', 'ID', 'Contact', 'Sessions Attended']);
  } else if (dayName && sessionType === 'Group meditation session') {
    // Group sessions for specific day
    const groupAttendance = {};
    
    masterRecords.forEach(r => {
      if (!r.id || !r.present) return;
      if (r.sessionName === dayName && r.sessionType === 'Group meditation session') {
        if (!groupAttendance[r.id]) {
          groupAttendance[r.id] = {
            name: r.name,
            id: r.id,
            contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A',
            count: 0
          };
        }
        groupAttendance[r.id].count++;
      }
    });
    
    filtered = Object.values(groupAttendance).sort((a, b) => b.count - a.count);
    displaySessionResults(filtered, `${dayName} Group Sessions`, 
      ['Rank', 'Name', 'ID', 'Contact', 'Sessions Attended']);
  }
}

function showAbhyasisAttendingAll() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = {
        name: r.name,
        id: r.id,
        contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A',
        hasWednesdayGroup: false,
        hasSundayGroup: false,
        hasFaceToFace: false,
        totalCount: 0
      };
    }
    
    attendanceMap[r.id].totalCount++;
    
    if (r.sessionName === 'Wednesday' && r.sessionType === 'Group meditation session') {
      attendanceMap[r.id].hasWednesdayGroup = true;
    }
    if (r.sessionName === 'Sunday' && r.sessionType === 'Group meditation session') {
      attendanceMap[r.id].hasSundayGroup = true;
    }
    if (r.sessionType === 'Face to face individual sittings') {
      attendanceMap[r.id].hasFaceToFace = true;
    }
  });

  const filtered = Object.values(attendanceMap)
    .filter(a => a.hasWednesdayGroup && a.hasSundayGroup && a.hasFaceToFace)
    .map(a => ({ 
      id: a.id, 
      name: a.name, 
      contact: a.contact, 
      sessionsAttended: a.totalCount 
    }))
    .sort((a, b) => b.sessionsAttended - a.sessionsAttended);

  displaySessionResults(filtered, 'All Three Session Types (Sunday + Wednesday + Face-to-Face)', 
    ['Rank', 'Name', 'ID', 'Contact', 'Total Sessions']);
}

function showAbhyasisGroupNotFaceToFace() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = {
        name: r.name,
        id: r.id,
        contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A',
        hasGroup: false,
        hasFace: false,
        groupCount: 0
      };
    }
    
    if (r.sessionType === 'Group meditation session') {
      attendanceMap[r.id].hasGroup = true;
      attendanceMap[r.id].groupCount++;
    }
    if (r.sessionType === 'Face to face individual sittings') {
      attendanceMap[r.id].hasFace = true;
    }
  });

  const filtered = Object.values(attendanceMap)
    .filter(a => a.hasGroup && !a.hasFace)
    .map(a => ({ id: a.id, name: a.name, contact: a.contact, groupSessions: a.groupCount }))
    .sort((a, b) => b.groupSessions - a.groupSessions);

  displaySessionResults(filtered, 'Group Sessions Only (No Face-to-Face)', 
    ['Rank', 'Name', 'ID', 'Contact', 'Group Sessions']);
}

function showAbhyasisFaceToFaceNotGroup() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = {
        name: r.name,
        id: r.id,
        contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A',
        hasGroup: false,
        hasFace: false,
        faceCount: 0
      };
    }
    
    if (r.sessionType === 'Group meditation session') {
      attendanceMap[r.id].hasGroup = true;
    }
    if (r.sessionType === 'Face to face individual sittings') {
      attendanceMap[r.id].hasFace = true;
      attendanceMap[r.id].faceCount++;
    }
  });

  const filtered = Object.values(attendanceMap)
    .filter(a => a.hasFace && !a.hasGroup)
    .map(a => ({ id: a.id, name: a.name, contact: a.contact, faceSessions: a.faceCount }))
    .sort((a, b) => b.faceSessions - a.faceSessions);

  displaySessionResults(filtered, 'Face-to-Face Only (No Group Sessions)', 
    ['Rank', 'Name', 'ID', 'Contact', 'Face-to-Face Sessions']);
}

function displaySessionResults(data, title, headers) {
  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += `<h3>${title}</h3>`;
  
  if (data.length === 0) {
    html += '<p style="color:#666;">No abhyasis found matching this criteria.</p>';
  } else {
    html += `<p style="margin-bottom:12px; color:#666;"><strong>Found: ${data.length} abhyasi(s)</strong></p>`;
    html += `<table class="report-table">
      <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
      <tbody>`;
    
    data.forEach((row, i) => {
      html += '<tr>';
      html += `<td><strong>${i + 1}</strong></td>`;
      
      Object.keys(row).forEach(key => {
        if (key === 'id') return;
        const value = row[key];
        
        if (typeof value === 'number') {
          html += `<td><span class="attendance-badge" style="background:#3498db;">${value}</span></td>`;
        } else {
          html += `<td>${escapeHtml(String(value))}</td>`;
        }
      });
      
      html += '</tr>';
    });
    
    html += '</tbody></table>';
  }
  
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}

// ============ ATTENDANCE PATTERNS & CONSISTENCY ============

function showMostConsistentAbhyasis() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};
  const registrationMap = {};

  masterRecords.forEach(r => {
    if (!r.id) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = { name: r.name, count: 0 };
      registrationMap[r.id] = new Set();
    }
    
    registrationMap[r.id].add(r.date);
    if (r.present) attendanceMap[r.id].count++;
  });

  const consistency = Object.entries(attendanceMap)
    .map(([id, data]) => {
      const registered = registrationMap[id].size;
      const percentage = registered > 0 ? Math.round((data.count / registered) * 100) : 0;
      return { id, name: data.name, attended: data.count, registered, percentage };
    })
    .filter(a => a.percentage >= 80)
    .sort((a, b) => b.percentage - a.percentage);

  displayAnalysisResults(consistency, 'Most Consistent Abhyasis (≥80% attendance rate)', 
    ['Rank', 'Name', 'ID', 'Attended', 'Registered', 'Consistency %']);
}

function showImprovingAttendance() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const now = new Date();
  const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const twoMonthsAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  const firstMonth = {};
  const lastMonth = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (r.date < oneMonthAgo) {
      if (!firstMonth[r.id]) firstMonth[r.id] = 0;
      if (r.date >= twoMonthsAgo) firstMonth[r.id]++;
    } else {
      if (!lastMonth[r.id]) lastMonth[r.id] = 0;
      lastMonth[r.id]++;
    }
  });

  const improving = Object.keys(lastMonth)
    .map(id => {
      const first = firstMonth[id] || 0;
      const last = lastMonth[id] || 0;
      const change = last - first;
      const name = masterRecords.find(r => r.id === id)?.name || id;
      return { id, name, firstMonth: first, lastMonth: last, improvement: change };
    })
    .filter(a => a.improvement > 0)
    .sort((a, b) => b.improvement - a.improvement);

  displayAnalysisResults(improving, 'Improving Attendance (Last 30 vs Previous 30 days)',
    ['Rank', 'Name', 'ID', 'Previous 30d', 'Last 30d', 'Improvement']);
}

function showDecliningAttendance() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const now = new Date();
  const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const twoMonthsAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  const firstMonth = {};
  const lastMonth = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (r.date < oneMonthAgo) {
      if (!firstMonth[r.id]) firstMonth[r.id] = 0;
      if (r.date >= twoMonthsAgo) firstMonth[r.id]++;
    } else {
      if (!lastMonth[r.id]) lastMonth[r.id] = 0;
      lastMonth[r.id]++;
    }
  });

  const declining = Object.keys(firstMonth)
    .map(id => {
      const first = firstMonth[id] || 0;
      const last = lastMonth[id] || 0;
      const change = last - first;
      const name = masterRecords.find(r => r.id === id)?.name || id;
      return { id, name, firstMonth: first, lastMonth: last, decline: change };
    })
    .filter(a => a.decline < 0)
    .sort((a, b) => a.decline - b.decline);

  displayAnalysisResults(declining, 'Declining Attendance (Last 30 vs Previous 30 days)',
    ['Rank', 'Name', 'ID', 'Previous 30d', 'Last 30d', 'Decline']);
}

function showReturningAbhyasis() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const sixtyDaysAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  const recentlyReturned = {};

  masterRecords.forEach(r => {
    if (!r.id) return;
    
    const isRecent = r.date >= thirtyDaysAgo;
    const wasAbsent = r.date < sixtyDaysAgo && r.date >= ninetyDaysAgo;
    
    if (isRecent && wasAbsent) {
      if (!recentlyReturned[r.id]) {
        recentlyReturned[r.id] = {
          name: r.name,
          lastSeen: r.date,
          recentCount: 0
        };
      }
      if (r.present) recentlyReturned[r.id].recentCount++;
    }
  });

  const returning = Object.entries(recentlyReturned)
    .map(([id, data]) => ({
      id,
      name: data.name,
      daysSinceReturn: Math.floor((new Date() - new Date(data.lastSeen)) / (24 * 60 * 60 * 1000)),
      recentAttendance: data.recentCount
    }))
    .sort((a, b) => a.daysSinceReturn - b.daysSinceReturn);

  displayAnalysisResults(returning, 'Returning Abhyasis (Absent 60-90d, Now Active)',
    ['Rank', 'Name', 'ID', 'Days Since Return', 'Recent Sessions']);
}

// ============ TIME-BASED ANALYSIS ============

function showNewAbhyasis() {
  if (!abhyasis.length) {
    showAlert('No abhyasis found', 'error');
    return;
  }

  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  const newMembers = abhyasis
    .filter(a => a.dateOfJoining && a.dateOfJoining >= thirtyDaysAgo)
    .map(a => {
      const joinedDate = new Date(a.dateOfJoining);
      const daysAsMember = Math.floor((now - joinedDate) / (24 * 60 * 60 * 1000));
      
      return {
        id: a.id,
        name: a.name,
        contact: a.contact || 'N/A',
        joinedDate: a.dateOfJoining,
        daysAsMember
      };
    })
    .sort((a, b) => b.joinedDate.localeCompare(a.joinedDate));

  displayAnalysisResults(newMembers, 'New Abhyasis (Last 30 days)',
    ['Rank', 'Name', 'ID', 'Contact', 'Joined Date', 'Days as Member']);
}
/////////////////////////////////////////////////////////////////////////////////////////
function showLoyalMembers() {
  if (!abhyasis.length) {
    showAlert('No abhyasis found', 'error');
    return;
  }

  const now = new Date();
  const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  const consistentMembers = {};

  // Count sessions attended for each abhyasi
  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!consistentMembers[r.id]) {
      const abhyasi = abhyasis.find(a => a.id === r.id);
      consistentMembers[r.id] = { 
        name: r.name, 
        count: 0, 
        dateOfJoining: abhyasi?.dateOfJoining || null
      };
    }
    
    consistentMembers[r.id].count++;
  });

  const loyal = Object.entries(consistentMembers)
    .filter(([id, data]) => data.dateOfJoining && data.dateOfJoining <= threeMonthsAgo && data.count >= 10)
    .map(([id, data]) => {
      const memberSince = new Date(data.dateOfJoining);
      const monthsActive = Math.floor((now - memberSince) / (30 * 24 * 60 * 60 * 1000));
      
      return {
        id,
        name: data.name,
        sessionsAttended: data.count,
        memberSince: data.dateOfJoining,
        monthsActive
      };
    })
    .sort((a, b) => b.sessionsAttended - a.sessionsAttended);

  displayAnalysisResults(loyal, 'Loyal Members (3+ months, 10+ sessions)',
    ['Rank', 'Name', 'ID', 'Sessions Attended', 'Member Since', 'Months Active']);
}
////////////////////////////////////////////////////////////////////////////////////////
function showMilestoneAchievers() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!attendanceMap[r.id]) {
      const abhyasi = abhyasis.find(a => a.id === r.id);
      attendanceMap[r.id] = { 
        name: r.name, 
        count: 0,
        dateOfJoining: abhyasi?.dateOfJoining || null
      };
    }
    attendanceMap[r.id].count++;
  });

  const achievers = Object.entries(attendanceMap)
    .map(([id, data]) => {
      const milestones = [];
      if (data.count >= 10) milestones.push('10');
      if (data.count >= 25) milestones.push('25');
      if (data.count >= 50) milestones.push('50');
      if (data.count >= 100) milestones.push('100');
      
      return { 
        id, 
        name: data.name, 
        sessionsAttended: data.count, 
        memberSince: data.dateOfJoining || 'N/A',
        milestones: milestones.length > 0 ? milestones.join(', ') + ' sessions' : 'None' 
      };
    })
    .filter(a => a.milestones !== 'None')
    .sort((a, b) => b.sessionsAttended - a.sessionsAttended);

  displayAnalysisResults(achievers, 'Milestone Achievers',
    ['Rank', 'Name', 'ID', 'Sessions Attended', 'Member Since', 'Milestones']);
}

// ============ FUNCTION 4: Returning Abhyasis ============
function showReturningAbhyasis() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const sixtyDaysAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  const recentlyReturned = {};

  masterRecords.forEach(r => {
    if (!r.id) return;
    
    const isRecent = r.date >= thirtyDaysAgo;
    const wasAbsent = r.date < sixtyDaysAgo && r.date >= ninetyDaysAgo;
    
    if (isRecent && wasAbsent) {
      if (!recentlyReturned[r.id]) {
        const abhyasi = abhyasis.find(a => a.id === r.id);
        recentlyReturned[r.id] = {
          name: r.name,
          contact: abhyasi?.contact || 'N/A',
          lastSeen: r.date,
          recentCount: 0
        };
      }
      if (r.present) recentlyReturned[r.id].recentCount++;
    }
  });

  const returning = Object.entries(recentlyReturned)
    .map(([id, data]) => ({
      id,
      name: data.name,
      contact: data.contact,
      daysSinceReturn: Math.floor((new Date() - new Date(data.lastSeen)) / (24 * 60 * 60 * 1000)),
      recentAttendance: data.recentCount
    }))
    .sort((a, b) => a.daysSinceReturn - b.daysSinceReturn);

  displayAnalysisResults(returning, 'Returning Abhyasis (Absent 60-90d, Now Active)',
    ['Rank', 'Name', 'ID', 'Contact', 'Days Since Return', 'Recent Sessions']);
}

// ============ FUNCTION 5: Trainer-Wise Distribution ============
function showTrainerWiseDistribution() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const trainerMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.trainer || !r.present) return;  // Only include attended sessions
    
    const trainer = r.trainer;
    if (!trainerMap[trainer]) {
      trainerMap[trainer] = {};
    }
    if (!trainerMap[trainer][r.id]) {
      const abhyasi = abhyasis.find(a => a.id === r.id);
      trainerMap[trainer][r.id] = { 
        name: r.name, 
        contact: abhyasi?.contact || 'N/A',
        sessionsAttended: 0 
      };
    }
    
    trainerMap[trainer][r.id].sessionsAttended++;
  });

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Trainer-Wise Distribution of Abhyasis</h3>';
  
  Object.keys(trainerMap).sort().forEach(trainer => {
    const abhyasisList = Object.entries(trainerMap[trainer])
      .map(([id, data]) => ({ id, name: data.name, contact: data.contact, sessionsAttended: data.sessionsAttended }))
      .sort((a, b) => b.sessionsAttended - a.sessionsAttended);
    
    html += `<div style="margin-bottom:20px; padding:12px; background:#f8f9fa; border-radius:8px;">
      <h4>${escapeHtml(trainer)} (${abhyasisList.length} abhyasis)</h4>
      <table class="report-table" style="margin-top:8px;">
        <thead><tr><th>#</th><th>Name</th><th>ID</th><th>Contact</th><th>Sessions Attended</th></tr></thead>
        <tbody>`;
    
    abhyasisList.forEach((a, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td>${escapeHtml(a.contact)}</td>
        <td><span class="attendance-badge" style="background:#3498db;">${a.sessionsAttended}</span></td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
  });
  
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}
//////////////////////////////////////////////////////////////////////////
// ============ FUNCTION 1: showEngagementByJoiningDate() ============
function showEngagementByJoiningDate() {
  console.log('Starting showEngagementByJoiningDate');
  console.log('abhyasis count:', abhyasis ? abhyasis.length : 0);
  console.log('masterRecords count:', masterRecords ? masterRecords.length : 0);
  
  if (!abhyasis || abhyasis.length === 0) {
    showAlert('No abhyasis found', 'error');
    return;
  }

  const now = new Date();
  const engagementData = [];

  abhyasis.forEach(a => {
    console.log('Processing abhyasi:', a.name, 'joining date:', a.dateOfJoining);
    
    if (!a.dateOfJoining) {
      console.log('  - Skipped: No joining date');
      return;
    }

    try {
      const joinedDate = new Date(a.dateOfJoining);
      if (isNaN(joinedDate.getTime())) {
        console.log('  - Skipped: Invalid date format');
        return;
      }

      const daysAsMember = Math.floor((now - joinedDate) / (24 * 60 * 60 * 1000));
      
      const sessionsAttended = (masterRecords || []).filter(r => 
        r && r.id === a.id && r.present && r.date && r.date >= a.dateOfJoining
      ).length;

      const totalSessionsRegistered = (masterRecords || []).filter(r => 
        r && r.id === a.id && r.date && r.date >= a.dateOfJoining
      ).length;

      const attendanceRate = totalSessionsRegistered > 0 
        ? Math.round((sessionsAttended / totalSessionsRegistered) * 100)
        : 0;

      console.log(`  - ${a.name}: ${sessionsAttended}/${totalSessionsRegistered} sessions, ${attendanceRate}% rate`);

      engagementData.push({
        id: a.id,
        name: a.name,
        contact: a.contact || 'N/A',
        joinedDate: a.dateOfJoining,
        daysAsMember,
        sessionsAttended,
        totalSessions: totalSessionsRegistered,
        attendanceRate
      });
    } catch (err) {
      console.error('Error processing abhyasi:', a.name, err);
    }
  });

  console.log('Total engagement data:', engagementData.length);

  engagementData.sort((a, b) => b.attendanceRate - a.attendanceRate);

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Engagement Analysis by Joining Date</h3>';
  
  if (engagementData.length === 0) {
    html += '<p style="color:#666;">No abhyasis with joining date found. Please add joining dates to abhyasis.</p>';
  } else {
    html += `<p style="margin-bottom:12px; color:#666;"><strong>Found ${engagementData.length} abhyasi(s)</strong></p>`;
    html += `<table class="report-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>ID</th>
          <th>Contact</th>
          <th>Joined Date</th>
          <th>Days as Member</th>
          <th>Sessions Attended</th>
          <th>Total Registered</th>
          <th>Attendance Rate</th>
        </tr>
      </thead>
      <tbody>`;
    
    engagementData.forEach((row, i) => {
      const rateColor = row.attendanceRate >= 80 ? '#27ae60' : 
                       row.attendanceRate >= 50 ? '#f39c12' : '#e74c3c';
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(row.name)}</td>
        <td>${escapeHtml(row.id)}</td>
        <td>${escapeHtml(row.contact)}</td>
        <td>${row.joinedDate}</td>
        <td>${row.daysAsMember}</td>
        <td>${row.sessionsAttended}</td>
        <td>${row.totalSessions}</td>
        <td><span class="attendance-badge" style="background:${rateColor};">${row.attendanceRate}%</span></td>
      </tr>`;
    });
    
    html += '</tbody></table>';
  }
  
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  if (!results) {
    console.error('reportResults container not found');
    return;
  }
  results.innerHTML = html;
  results.style.display = 'block';
}

// ============ FUNCTION 2: showJoiningDateStats() ============
function showJoiningDateStats() {
  console.log('Starting showJoiningDateStats');
  console.log('abhyasis count:', abhyasis ? abhyasis.length : 0);
  
  if (!abhyasis || abhyasis.length === 0) {
    showAlert('No abhyasis found', 'error');
    return;
  }

  const now = new Date();
  const stats = {
    last7Days: [],
    last30Days: [],
    last90Days: [],
    last6Months: [],
    older: []
  };

  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const sixMonthsAgo = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  console.log('Date ranges:');
  console.log('  Last 7 days:', sevenDaysAgo);
  console.log('  Last 30 days:', thirtyDaysAgo);
  console.log('  Last 90 days:', ninetyDaysAgo);
  console.log('  Last 6 months:', sixMonthsAgo);

  abhyasis.forEach(a => {
    if (!a.dateOfJoining) {
      console.log(`${a.name} - No joining date`);
      return;
    }
    
    console.log(`${a.name} - Joined: ${a.dateOfJoining}`);
    
    if (a.dateOfJoining >= sevenDaysAgo) {
      console.log('  -> Last 7 days');
      stats.last7Days.push(a);
    } else if (a.dateOfJoining >= thirtyDaysAgo) {
      console.log('  -> Last 30 days');
      stats.last30Days.push(a);
    } else if (a.dateOfJoining >= ninetyDaysAgo) {
      console.log('  -> Last 90 days');
      stats.last90Days.push(a);
    } else if (a.dateOfJoining >= sixMonthsAgo) {
      console.log('  -> Last 6 months');
      stats.last6Months.push(a);
    } else {
      console.log('  -> Older');
      stats.older.push(a);
    }
  });

  console.log('Final stats:', {
    last7: stats.last7Days.length,
    last30: stats.last30Days.length,
    last90: stats.last90Days.length,
    last6m: stats.last6Months.length,
    older: stats.older.length
  });

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Abhyasi Joining Distribution</h3>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin-top:12px;">';
  
  html += `<div style="background:#d1ecf1; padding:12px; border-radius:8px; border-left:4px solid #17a2b8; text-align:center;">
    <div style="font-size:24px; font-weight:bold; color:#0c5460;">${stats.last7Days.length}</div>
    <div style="color:#0c5460; font-size:12px;">Last 7 Days</div>
  </div>`;
  
  html += `<div style="background:#d4edda; padding:12px; border-radius:8px; border-left:4px solid #28a745; text-align:center;">
    <div style="font-size:24px; font-weight:bold; color:#155724;">${stats.last30Days.length}</div>
    <div style="color:#155724; font-size:12px;">Last 30 Days</div>
  </div>`;
  
  html += `<div style="background:#fff3cd; padding:12px; border-radius:8px; border-left:4px solid #ffc107; text-align:center;">
    <div style="font-size:24px; font-weight:bold; color:#856404;">${stats.last90Days.length}</div>
    <div style="color:#856404; font-size:12px;">Last 90 Days</div>
  </div>`;
  
  html += `<div style="background:#f8d7da; padding:12px; border-radius:8px; border-left:4px solid #dc3545; text-align:center;">
    <div style="font-size:24px; font-weight:bold; color:#721c24;">${stats.last6Months.length}</div>
    <div style="color:#721c24; font-size:12px;">6 Months</div>
  </div>`;
  
  html += `<div style="background:#e2e3e5; padding:12px; border-radius:8px; border-left:4px solid #6c757d; text-align:center;">
    <div style="font-size:24px; font-weight:bold; color:#383d41;">${stats.older.length}</div>
    <div style="color:#383d41; font-size:12px;">Older</div>
  </div>`;
  
  html += '</div>';

  html += '<div style="margin-top:20px;">';
  
  if (stats.last7Days.length > 0) {
    html += '<h4 style="color:#0c5460;">Last 7 Days (' + stats.last7Days.length + ')</h4>';
    html += '<ul style="margin:8px 0; padding-left:20px;">';
    stats.last7Days.forEach(a => {
      html += `<li>${escapeHtml(a.name)} - ${a.dateOfJoining}</li>`;
    });
    html += '</ul>';
  }

  if (stats.last30Days.length > 0) {
    html += '<h4 style="color:#155724;">Last 30 Days (' + stats.last30Days.length + ')</h4>';
    html += '<ul style="margin:8px 0; padding-left:20px;">';
    stats.last30Days.forEach(a => {
      html += `<li>${escapeHtml(a.name)} - ${a.dateOfJoining}</li>`;
    });
    html += '</ul>';
  }

  if (stats.last90Days.length > 0) {
    html += '<h4 style="color:#856404;">Last 90 Days (' + stats.last90Days.length + ')</h4>';
    html += '<ul style="margin:8px 0; padding-left:20px;">';
    stats.last90Days.forEach(a => {
      html += `<li>${escapeHtml(a.name)} - ${a.dateOfJoining}</li>`;
    });
    html += '</ul>';
  }

  if (stats.last6Months.length > 0) {
    html += '<h4 style="color:#721c24;">Last 6 Months (' + stats.last6Months.length + ')</h4>';
    html += '<ul style="margin:8px 0; padding-left:20px;">';
    stats.last6Months.forEach(a => {
      html += `<li>${escapeHtml(a.name)} - ${a.dateOfJoining}</li>`;
    });
    html += '</ul>';
  }

  if (stats.older.length > 0) {
    html += '<h4 style="color:#383d41;">Older (' + stats.older.length + ')</h4>';
    html += '<ul style="margin:8px 0; padding-left:20px;">';
    stats.older.forEach(a => {
      html += `<li>${escapeHtml(a.name)} - ${a.dateOfJoining}</li>`;
    });
    html += '</ul>';
  }

  html += '</div></div>';
  
  const results = document.getElementById('reportResults');
  if (!results) {
    console.error('reportResults container not found');
    return;
  }
  results.innerHTML = html;
  results.style.display = 'block';
}

// ============ FUNCTION 3: showAbhyasisByJoiningDate() ============
function showAbhyasisByJoiningDate() {
  console.log('Starting showAbhyasisByJoiningDate');
  console.log('Total abhyasis:', abhyasis ? abhyasis.length : 0);
  
  if (!abhyasis || abhyasis.length === 0) {
    showAlert('No abhyasis found', 'error');
    return;
  }

  const withJoiningDate = abhyasis
    .filter(a => a.dateOfJoining && a.dateOfJoining.trim() !== '')
    .map(a => {
      const joinedDate = new Date(a.dateOfJoining);
      const daysAsMember = Math.floor((new Date() - joinedDate) / (24 * 60 * 60 * 1000));
      
      const attendance = (masterRecords || []).filter(r => 
        r && r.id === a.id && r.present && r.date >= a.dateOfJoining
      ).length;

      const totalSessions = (masterRecords || []).filter(r => 
        r && r.id === a.id && r.date >= a.dateOfJoining
      ).length;

      const attendanceRate = totalSessions > 0 
        ? Math.round((attendance / totalSessions) * 100)
        : 0;

      return {
        name: a.name,
        id: a.id,
        contact: a.contact || 'N/A',
        dateOfJoining: a.dateOfJoining,
        daysAsMember,
        sessionsAttended: attendance,
        totalSessions,
        attendanceRate
      };
    })
    .sort((a, b) => new Date(b.dateOfJoining) - new Date(a.dateOfJoining));

  console.log('Abhyasis with joining dates:', withJoiningDate.length);

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Abhyasis Ordered by Joining Date (Newest First)</h3>';
  
  if (withJoiningDate.length === 0) {
    html += '<p style="color:#666;">No abhyasis with joining date found. Please add joining dates in Manage Abhyasis.</p>';
  } else {
    html += `<p style="margin-bottom:12px; color:#666;"><strong>Total: ${withJoiningDate.length} abhyasi(s)</strong></p>`;
    
    html += `<table class="report-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>ID</th>
          <th>Contact</th>
          <th>Joined Date</th>
          <th>Days as Member</th>
          <th>Sessions Attended</th>
          <th>Total Sessions</th>
          <th>Attendance %</th>
        </tr>
      </thead>
      <tbody>`;
    
    withJoiningDate.forEach((a, i) => {
      let statusColor = '#27ae60';
      if (a.attendanceRate < 50) statusColor = '#e74c3c';
      else if (a.attendanceRate < 75) statusColor = '#f39c12';
      
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td>${escapeHtml(a.contact)}</td>
        <td style="font-weight:500;">${a.dateOfJoining}</td>
        <td>${a.daysAsMember}</td>
        <td>${a.sessionsAttended}</td>
        <td>${a.totalSessions}</td>
        <td><span class="attendance-badge" style="background:${statusColor};">${a.attendanceRate}%</span></td>
      </tr>`;
    });
    
    html += '</tbody></table>';
  }
  
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  if (!results) {
    console.error('reportResults container not found');
    return;
  }
  results.innerHTML = html;
  results.style.display = 'block';
}
///////////////////////////////////////////////////////////////////////

// ============ ENGAGEMENT METRICS ============

function showMostActiveThisMonth() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const now = new Date();
  const currentMonth = now.toISOString().slice(0, 7);

  const monthlyAttendance = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present || !r.date.startsWith(currentMonth)) return;
    
    if (!monthlyAttendance[r.id]) {
      monthlyAttendance[r.id] = { name: r.name, count: 0 };
    }
    monthlyAttendance[r.id].count++;
  });

  const topThisMonth = Object.entries(monthlyAttendance)
    .map(([id, data]) => ({ id, name: data.name, sessionsThisMonth: data.count }))
    .sort((a, b) => b.sessionsThisMonth - a.sessionsThisMonth)
    .slice(0, 10);

  displayAnalysisResults(topThisMonth, 'Most Active This Month',
    ['Rank', 'Name', 'ID', 'Sessions This Month']);
}

function showHighestOverallAttendance() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const allTimeAttendance = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.present) return;
    
    if (!allTimeAttendance[r.id]) {
      allTimeAttendance[r.id] = { name: r.name, count: 0 };
    }
    allTimeAttendance[r.id].count++;
  });

  const topAll = Object.entries(allTimeAttendance)
    .map(([id, data]) => ({ id, name: data.name, allTimeAttendance: data.count }))
    .sort((a, b) => b.allTimeAttendance - a.allTimeAttendance)
    .slice(0, 15);

  displayAnalysisResults(topAll, 'Highest Overall Attendance (All-Time)',
    ['Rank', 'Name', 'ID', 'Total Sessions Attended']);
}

function showTrainerWiseDistribution() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const trainerMap = {};

  masterRecords.forEach(r => {
    if (!r.id || !r.trainer || !r.present) return;  // Only include attended sessions
    
    const trainer = r.trainer;
    if (!trainerMap[trainer]) {
      trainerMap[trainer] = {};
    }
    if (!trainerMap[trainer][r.id]) {
      const abhyasi = abhyasis.find(a => a.id === r.id);
      trainerMap[trainer][r.id] = { 
        name: r.name, 
        contact: abhyasi?.contact || 'N/A',
        sessionsAttended: 0 
      };
    }
    
    trainerMap[trainer][r.id].sessionsAttended++;
  });

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Trainer-Wise Distribution of Abhyasis</h3>';
  
  Object.keys(trainerMap).sort().forEach(trainer => {
    const abhyasisList = Object.entries(trainerMap[trainer])
      .map(([id, data]) => ({ id, name: data.name, contact: data.contact, sessionsAttended: data.sessionsAttended }))
      .sort((a, b) => b.sessionsAttended - a.sessionsAttended);
    
    html += `<div style="margin-bottom:20px; padding:12px; background:#f8f9fa; border-radius:8px;">
      <h4>${escapeHtml(trainer)} (${abhyasisList.length} abhyasis)</h4>
      <table class="report-table" style="margin-top:8px;">
        <thead><tr><th>#</th><th>Name</th><th>ID</th><th>Contact</th><th>Sessions Attended</th></tr></thead>
        <tbody>`;
    
    abhyasisList.forEach((a, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td>${escapeHtml(a.contact)}</td>
        <td><span class="attendance-badge" style="background:#3498db;">${a.sessionsAttended}</span></td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
  });
  
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}
// ============ RISK & FOLLOW-UP ============

function showAtRiskAbhyasis() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};

  masterRecords.forEach(r => {
    if (!r.id) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = { name: r.name, present: 0, total: 0, contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A' };
    }
    
    attendanceMap[r.id].total++;
    if (r.present) attendanceMap[r.id].present++;
  });

  const atRisk = Object.entries(attendanceMap)
    .map(([id, data]) => {
      const percentage = data.total > 0 ? Math.round((data.present / data.total) * 100) : 0;
      return { id, name: data.name, contact: data.contact, attended: data.present, total: data.total, percentage };
    })
    .filter(a => a.percentage > 25 && a.percentage <= 50)
    .sort((a, b) => a.percentage - b.percentage);

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>At-Risk Abhyasis (25-50% Sporadic Attendance)</h3>';
  
  if (atRisk.length === 0) {
    html += '<p style="color:#666;">No at-risk abhyasis found.</p>';
  } else {
    html += `<table class="report-table">
      <thead><tr><th>Rank</th><th>Name</th><th>ID</th><th>Contact</th><th>Attended</th><th>Total</th><th>Attendance %</th></tr></thead>
      <tbody>`;
    
    atRisk.forEach((a, i) => {
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td>${escapeHtml(a.contact)}</td>
        <td>${a.attended}</td>
        <td>${a.total}</td>
        <td><span class="attendance-badge" style="background:#f39c12;">${a.percentage}%</span></td>
      </tr>`;
    });
    
    html += '</tbody></table>';
  }
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}


// ============ FUNCTION 1: Low Attendance (≤50%) - FIXED ============
function showLowAttendanceAbhyasis() {
  if (!masterRecords.length) {
    showAlert('No records available', 'error');
    return;
  }

  const attendanceMap = {};
  
  // Count attendance from masterRecords
  masterRecords.forEach(r => {
    if (!r.id) return;
    
    if (!attendanceMap[r.id]) {
      attendanceMap[r.id] = {
        name: r.name,
        id: r.id,
        totalRegistered: 0,
        attended: 0,
        contact: abhyasis.find(a => a.id === r.id)?.contact || 'N/A'
      };
    }
    
    attendanceMap[r.id].totalRegistered++;
    if (r.present) {
      attendanceMap[r.id].attended++;
    }
  });

  const lowAttendance = Object.entries(attendanceMap)
    .map(([id, data]) => ({
      ...data,
      percentage: data.totalRegistered > 0 ? Math.round((data.attended / data.totalRegistered) * 100) : 0
    }))
    .filter(a => a.percentage <= 50)
    .sort((a, b) => a.percentage - b.percentage);

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Low Attendance (≤50%)</h3>';
  html += '<p style="color:#666; font-size:13px; margin-bottom:12px;"><em>Based on attendance records from "View All Records"</em></p>';
  
  if (lowAttendance.length === 0) {
    html += '<p style="color:#27ae60; font-weight:bold;">✅ Great news! All abhyasis with records have attendance above 50%.</p>';
  } else {
    html += `<p style="margin-bottom:12px; color:#666;">Found ${lowAttendance.length} abhyasi(s) with attendance at or below 50%</p>`;
    html += `<table class="report-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>ID</th>
          <th>Contact</th>
          <th>Registered</th>
          <th>Attended</th>
          <th>Attendance %</th>
        </tr>
      </thead>
      <tbody>`;
    
    lowAttendance.forEach((a, i) => {
      const statusColor = a.percentage === 0 ? '#95a5a6' : 
                         a.percentage <= 25 ? '#c0392b' : 
                         a.percentage <= 40 ? '#e67e22' : '#f39c12';
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td>${escapeHtml(a.contact)}</td>
        <td>${a.totalRegistered}</td>
        <td>${a.attended}</td>
        <td>
          <span class="attendance-badge" style="background:${statusColor};">
            ${a.percentage}%
          </span>
        </td>
      </tr>`;
    });
    
    html += '</tbody></table>';
    
    html += `<div style="margin-top:16px; padding:12px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:4px;">
      <strong>📞 Follow-up Recommended:</strong> Consider reaching out to these abhyasis to understand any challenges they may be facing.
    </div>`;
  }
  
  html += '</div>';

  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}

// ============ FUNCTION 2: Inactive (60+ days) - FIXED ============
function showZeroAttendanceLastSixty() {
  if (!masterRecords.length && !abhyasis.length) {
    showAlert('No records or abhyasis available', 'error');
    return;
  }

  const now = new Date();
  const sixtyDaysAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

  // Track all abhyasis who have any attendance record
  const allTrackedAbhyasis = new Set();
  const recentActivity = new Set();
  const lastSeenMap = {};

  masterRecords.forEach(r => {
    if (!r.id) return;
    
    allTrackedAbhyasis.add(r.id);
    
    // Track last seen date for each abhyasi
    if (!lastSeenMap[r.id] || r.date > lastSeenMap[r.id]) {
      lastSeenMap[r.id] = r.date;
    }
    
    // Check if they were active in last 60 days
    if (r.date >= sixtyDaysAgo) {
      recentActivity.add(r.id);
    }
  });

  // Find inactive abhyasis (either no records at all, or no activity in 60 days)
  const inactive = [];

  // Add abhyasis from the main list who have never attended
  abhyasis.forEach(a => {
    if (!allTrackedAbhyasis.has(a.id)) {
      // Never attended any session
      inactive.push({
        id: a.id,
        name: a.name,
        contact: a.contact || 'N/A',
        lastSeen: 'Never attended',
        daysSinceActive: 999,
        status: 'Never attended'
      });
    }
  });

  // Add abhyasis who have records but no recent activity
  allTrackedAbhyasis.forEach(id => {
    if (!recentActivity.has(id)) {
      const record = masterRecords.find(r => r.id === id);
      const abhyasi = abhyasis.find(a => a.id === id);
      const lastSeen = lastSeenMap[id] || 'Unknown';
      const daysSinceActive = lastSeen !== 'Unknown' 
        ? Math.floor((now - new Date(lastSeen)) / (24 * 60 * 60 * 1000))
        : 999;
      
      inactive.push({
        id,
        name: record?.name || abhyasi?.name || id,
        contact: abhyasi?.contact || 'N/A',
        lastSeen,
        daysSinceActive,
        status: `Inactive ${daysSinceActive}+ days`
      });
    }
  });

  // Sort by days inactive (highest first)
  inactive.sort((a, b) => b.daysSinceActive - a.daysSinceActive);

  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>Inactive Abhyasis (No Attendance in Last 60 Days)</h3>';
  html += '<p style="color:#666; font-size:13px; margin-bottom:12px;"><em>Includes abhyasis with no attendance records or no activity in 60+ days</em></p>';
  
  if (inactive.length === 0) {
    html += '<p style="color:#27ae60; font-weight:bold;">✅ Excellent! All abhyasis have been active in the last 60 days.</p>';
  } else {
    html += `<p style="margin-bottom:12px; color:#666;"><strong>Found ${inactive.length} inactive abhyasi(s)</strong></p>`;
    html += `<table class="report-table">
      <thead><tr><th>Rank</th><th>Name</th><th>ID</th><th>Contact</th><th>Last Seen</th><th>Status</th></tr></thead>
      <tbody>`;
    
    inactive.forEach((a, i) => {
      const dayColor = a.daysSinceActive === 999 ? '#7f8c8d' :
                       a.daysSinceActive > 180 ? '#c0392b' : 
                       a.daysSinceActive > 120 ? '#e67e22' : 
                       a.daysSinceActive > 90 ? '#f39c12' : '#95a5a6';
      
      const lastSeenDisplay = a.lastSeen === 'Never attended' ? 
        '<span style="color:#7f8c8d; font-style:italic;">Never attended</span>' : 
        a.lastSeen;
      
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td>${escapeHtml(a.contact)}</td>
        <td>${lastSeenDisplay}</td>
        <td><span class="attendance-badge" style="background:${dayColor};">${a.status}</span></td>
      </tr>`;
    });
    
    html += '</tbody></table>';
    html += `<div style="margin-top:16px; padding:12px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:4px;">
      <strong>📞 Priority Follow-up:</strong> Consider reaching out to these abhyasis to understand if there are barriers to attendance.
    </div>`;
  }
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}
// ============ TREND REPORTS - 1, 3, 6 MONTHS (FIXED) ============
// ============ TREND REPORTS - 1, 3, 6 MONTHS (NO BLANKS) ============

function showTrendReport(months) {
  const now = new Date();
  const start = new Date();
  start.setMonth(now.getMonth() - months);

  const startStr = start.toISOString().slice(0, 10);
  const endStr = now.toISOString().slice(0, 10);

  // Collect attendance by date and session
  const wednesdayData = {};
  const sundayData = {};
  const faceData = {};

  masterRecords.forEach(record => {
    const date = record.date;
    if (!date || date < startStr || date > endStr || !record.present) return;

    if (record.sessionType?.includes('Group')) {
      if (record.sessionName === 'Wednesday') {
        if (!wednesdayData[date]) wednesdayData[date] = 0;
        wednesdayData[date]++;
      } else if (record.sessionName === 'Sunday') {
        if (!sundayData[date]) sundayData[date] = 0;
        sundayData[date]++;
      }
    }
    
    if (record.sessionType?.includes('Face')) {
      if (!faceData[date]) faceData[date] = 0;
      faceData[date]++;
    }
  });

  // Build arrays for each session type (only dates with data)
  const wednesdayDates = Object.entries(wednesdayData)
    .sort((a, b) => a[0].localeCompare(b[0]));

  const sundayDates = Object.entries(sundayData)
    .sort((a, b) => a[0].localeCompare(b[0]));

  const faceDates = Object.entries(faceData)
    .sort((a, b) => a[0].localeCompare(b[0]));

  // Render the HTML
  let html = `<div style="background:white; padding:12px; border-radius:8px; margin-top:16px;">
                <h3>${months}-Month Attendance Trend</h3>`;

  if (wednesdayDates.length === 0 && sundayDates.length === 0 && faceDates.length === 0) {
    html += `<p style="color:#666;">No attendance records found in the last ${months} month(s).</p></div>`;
    const results = document.getElementById('reportResults');
    results.innerHTML = html;
    results.style.display = 'block';
    return;
  }

  // Wednesday chart
  if (wednesdayDates.length > 0) {
    html += `<p style="color:#666; font-size:14px; margin-bottom:16px;">
              Wednesday Group Sessions: ${wednesdayDates.length} dates with attendance
            </p>
            <div style="margin-bottom:30px;">
              <h4 style="color:#9b59b6; margin-bottom:12px;">Wednesday Group Meditation</h4>
              <div style="position:relative; height:150px;">
                <canvas id="wednesdayTrendChart"></canvas>
              </div>
            </div>`;
  }

  // Sunday chart
  if (sundayDates.length > 0) {
    html += `<p style="color:#666; font-size:14px; margin-bottom:16px;">
              Sunday Group Sessions: ${sundayDates.length} dates with attendance
            </p>
            <div style="margin-bottom:30px;">
              <h4 style="color:#2ecc71; margin-bottom:12px;">Sunday Group Meditation</h4>
              <div style="position:relative; height:150px;">
                <canvas id="sundayTrendChart"></canvas>
              </div>
            </div>`;
  }

  // Face-to-face chart
  if (faceDates.length > 0) {
    html += `<p style="color:#666; font-size:14px; margin-bottom:16px;">
              Face-to-Face: ${faceDates.length} dates with attendance
            </p>
            <div>
              <h4 style="color:#3498db; margin-bottom:12px;">Face-to-Face Sittings</h4>
              <div style="position:relative; height:150px;">
                <canvas id="faceTrendChart"></canvas>
              </div>
            </div>`;
  }

  html += `</div>`;

  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';

  // Render charts after a short delay
  setTimeout(() => {
    // Wednesday chart
    if (wednesdayDates.length > 0) {
      const wedLabels = wednesdayDates.map(([d]) => new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
      const wedValues = wednesdayDates.map(([, count]) => count);
      const maxWed = Math.max(...wedValues, 5);

      const ctxWed = document.getElementById('wednesdayTrendChart');
      if (ctxWed) {
        new Chart(ctxWed.getContext('2d'), {
          type: 'bar',
          data: {
            labels: wedLabels,
            datasets: [{
              label: 'Abhyasis Present',
              data: wedValues,
              backgroundColor: '#9b59b6',
              borderColor: '#8e44ad',
              borderWidth: 1,
              barThickness: 'flex',
              barPercentage: 0.8,
              categoryPercentage: 0.9
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 3,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                min: 0,
                max: maxWed + 2,
                ticks: {
                  stepSize: Math.max(1, Math.ceil(maxWed / 5)),
                  callback: function(value) {
                    if (Number.isInteger(value)) return value;
                  }
                },
                grid: { display: true }
              },
              x: {
                offset: false,
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: { size: 9 },
                  autoSkip: false
                }
              }
            },
            layout: { padding: { top: 10, bottom: 0 } }
          }
        });
      }
    }

    // Sunday chart
    if (sundayDates.length > 0) {
      const sunLabels = sundayDates.map(([d]) => new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
      const sunValues = sundayDates.map(([, count]) => count);
      const maxSun = Math.max(...sunValues, 5);

      const ctxSun = document.getElementById('sundayTrendChart');
      if (ctxSun) {
        new Chart(ctxSun.getContext('2d'), {
          type: 'bar',
          data: {
            labels: sunLabels,
            datasets: [{
              label: 'Abhyasis Present',
              data: sunValues,
              backgroundColor: '#2ecc71',
              borderColor: '#27ae60',
              borderWidth: 1,
              barThickness: 'flex',
              barPercentage: 0.8,
              categoryPercentage: 0.9
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 3,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                min: 0,
                max: maxSun + 2,
                ticks: {
                  stepSize: Math.max(1, Math.ceil(maxSun / 5)),
                  callback: function(value) {
                    if (Number.isInteger(value)) return value;
                  }
                },
                grid: { display: true }
              },
              x: {
                offset: false,
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: { size: 9 },
                  autoSkip: false
                }
              }
            },
            layout: { padding: { top: 10, bottom: 0 } }
          }
        });
      }
    }

    // Face-to-face chart
    if (faceDates.length > 0) {
      const faceLabels = faceDates.map(([d]) => new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
      const faceValues = faceDates.map(([, count]) => count);
      const maxFace = Math.max(...faceValues, 5);

      const ctxFace = document.getElementById('faceTrendChart');
      if (ctxFace) {
        new Chart(ctxFace.getContext('2d'), {
          type: 'bar',
          data: {
            labels: faceLabels,
            datasets: [{
              label: 'Abhyasis Present',
              data: faceValues,
              backgroundColor: '#3498db',
              borderColor: '#2980b9',
              borderWidth: 1,
              barThickness: 'flex',
              barPercentage: 0.8,
              categoryPercentage: 0.9
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 3,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                min: 0,
                max: maxFace + 2,
                ticks: {
                  stepSize: Math.max(1, Math.ceil(maxFace / 5)),
                  callback: function(value) {
                    if (Number.isInteger(value)) return value;
                  }
                },
                grid: { display: true }
              },
              x: {
                offset: false,
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: { size: 9 },
                  autoSkip: false
                }
              }
            },
            layout: { padding: { top: 10, bottom: 0 } }
          }
        });
      }
    }
  }, 100);
}
// ============ HELPER FUNCTIONS ============

function displayAnalysisResults(data, title, headers) {
  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += `<h3>${title}</h3>`;
  
  if (data.length === 0) {
    html += '<p style="color:#666;">No data found matching this criteria.</p>';
  } else {
    html += `<table class="report-table">
      <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
      <tbody>`;
    
    data.forEach((row, i) => {
      html += '<tr>';
      html += `<td><strong>${i + 1}</strong></td>`;
      
      Object.keys(row).forEach(key => {
        if (key === 'id') return;
        const value = row[key];
        
        if (typeof value === 'number' && (key.includes('percentage') || key.includes('%') || key.includes('balance') || key.includes('Consistency'))) {
          html += `<td><span class="attendance-badge" style="background:#3498db;">${value}%</span></td>`;
        } else if (key.includes('contact') && value && value !== 'N/A') {
          html += `<td>${escapeHtml(value)}</td>`;
        } else {
          html += `<td>${escapeHtml(String(value))}</td>`;
        }
      });
      
      html += '</tr>';
    });
    
    html += '</tbody></table>';
  }
  
  html += '</div>';
  
  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}

// ============ COMPREHENSIVE ANALYSIS FILTERS ============

function showTopAbhyasis() {
  if (!masterRecords || masterRecords.length === 0) {
    showAlert('No master records available', 'error');
    return;
  }

  const groupAttendance = {};
  const faceAttendance = {};

  masterRecords.forEach(r => {
    if (!r.present || !r.id) return;
    
    if (r.sessionType?.includes('Group')) {
      if (!groupAttendance[r.id]) {
        groupAttendance[r.id] = { name: r.name, count: 0 };
      }
      groupAttendance[r.id].count++;
    }
    
    if (r.sessionType?.includes('Face')) {
      if (!faceAttendance[r.id]) {
        faceAttendance[r.id] = { name: r.name, count: 0 };
      }
      faceAttendance[r.id].count++;
    }
  });

  const groupTop = Object.entries(groupAttendance)
    .map(([id, data]) => ({ id, name: data.name, count: data.count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 10);

  const faceTop = Object.entries(faceAttendance)
    .map(([id, data]) => ({ id, name: data.name, count: data.count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 10);

  let html = '<div style="margin-top:16px;">';

  html += `<div style="background:white; padding:16px; border-radius:8px; margin-bottom:20px;">
    <h3 style="color:#2ecc71;">Group Meditation Sessions - Top Attendees</h3>`;
  
  if (groupTop.length === 0) {
    html += '<p style="color:#666;">No group session attendance found.</p>';
  } else {
    html += `<table class="report-table">
      <thead><tr><th>Rank</th><th>Name</th><th>ID</th><th>Sessions Attended</th></tr></thead>
      <tbody>`;
    groupTop.forEach((a, i) => {
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td><span class="attendance-badge" style="background:#2ecc71;">${a.count}</span></td>
      </tr>`;
    });
    html += '</tbody></table>';
  }
  html += '</div>';

  html += `<div style="background:white; padding:16px; border-radius:8px;">
    <h3 style="color:#3498db;">Face-to-Face Sittings - Top Attendees</h3>`;
  
  if (faceTop.length === 0) {
    html += '<p style="color:#666;">No face-to-face attendance found.</p>';
  } else {
    html += `<table class="report-table">
      <thead><tr><th>Rank</th><th>Name</th><th>ID</th><th>Sessions Attended</th></tr></thead>
      <tbody>`;
    faceTop.forEach((a, i) => {
      html += `<tr>
        <td><strong>${i + 1}</strong></td>
        <td>${escapeHtml(a.name)}</td>
        <td>${escapeHtml(a.id)}</td>
        <td><span class="attendance-badge" style="background:#3498db;">${a.count}</span></td>
      </tr>`;
    });
    html += '</tbody></table>';
  }
  html += '</div>';

  html += '</div>';

  const results = document.getElementById('reportResults');
  results.innerHTML = html;
  results.style.display = 'block';
}

function showComprehensiveAnalysis() {
  if (!masterRecords || masterRecords.length === 0) {
    showAlert('No master records available', 'error');
    return;
  }

  const results = document.getElementById('reportResults');
  results.style.display = 'block';
  
  let html = '<div style="background:white; padding:16px; border-radius:8px; margin-top:16px;">';
  html += '<h3>📊 Comprehensive Attendance Analysis</h3>';
  
  // Trend Analysis
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">📈 Trend Analysis</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px;">';
  html += '<button class="btn btn-success" onclick="showTrendReport(1)">📈 1-Month Trend</button>';
  html += '<button class="btn btn-success" onclick="showTrendReport(3)">📉 3-Month Trend</button>';
  html += '<button class="btn btn-success" onclick="showTrendReport(6)">📊 6-Month Trend</button>';
  html += '</div></div>';
  
  // Session-Based Filters
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">🎯 Session-Based Filters</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">';
  html += '<button class="btn btn-success" onclick="showAbhyasisBySessionOnly(\'Wednesday\', \'Group meditation session\')">🧘 Wednesday Group Only</button>';
  html += '<button class="btn btn-success" onclick="showAbhyasisBySessionOnly(\'Sunday\', \'Group meditation session\')">🧘 Sunday Group Only</button>';
  html += '<button class="btn btn-success" onclick="showAbhyasisBySessionOnly(null, \'Face to face individual sittings\')">👤 Face-to-Face Only</button>';
  html += '<button class="btn btn-warning" onclick="showAbhyasisAttendingAll()">⭐ All Three Sessions</button>';
  html += '<button class="btn" onclick="showAbhyasisGroupNotFaceToFace()">🧘 Group Only (No F2F)</button>';
  html += '<button class="btn" onclick="showAbhyasisFaceToFaceNotGroup()">👤 F2F Only (No Group)</button>';
  html += '</div></div>';
  
  // Top Performers
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">🏆 Top Performers</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">';
  html += '<button class="btn btn-success" onclick="showHighestOverallAttendance()">💪 Top Attendance (All-Time)</button>';
  html += '<button class="btn btn-success" onclick="showMostActiveThisMonth()">🔥 Most Active This Month</button>';
  html += '<button class="btn btn-success" onclick="showTopAbhyasis()">🏆 Top By Session Type</button>';
  html += '</div></div>';
  
  // Attendance Patterns
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">📈 Attendance Patterns</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">';
  html += '<button class="btn btn-success" onclick="showMostConsistentAbhyasis()">👥 Most Consistent (80%+)</button>';
  html += '<button class="btn btn-success" onclick="showImprovingAttendance()">📈 Improving Attendance</button>';
  html += '<button class="btn btn-danger" onclick="showDecliningAttendance()">📉 Declining Attendance</button>';
  html += '<button class="btn" onclick="showReturningAbhyasis()">🔄 Returning Abhyasis</button>';
  html += '</div></div>';
  

  // Loyalty & Engagement
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">⏰ Loyalty & Engagement</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">';
  html += '<button class="btn btn-info" onclick="showNewAbhyasis()">🆕 New (Last 30 days)</button>';
  html += '<button class="btn btn-info" onclick="showLoyalMembers()">⭐ Loyal (3+ months)</button>';
  html += '<button class="btn btn-info" onclick="showMilestoneAchievers()">🎁 Milestone Achievers</button>';
  html += '<button class="btn btn-info" onclick="showEngagementByJoiningDate()">📊 Engagement by Joining Date</button>';
  html += '<button class="btn btn-info" onclick="showJoiningDateStats()">📈 Joining Distribution Stats</button>';
  html += '<button class="btn btn-info" onclick="showAbhyasisByJoiningDate()">📋 All Abhyasis by Joining Date</button>';
  html += '</div></div>';

  // Risk & Attention Needed
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">⚠️ Risk & Attention Needed</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">';
  html += '<button class="btn btn-warning" onclick="showLowAttendanceAbhyasis()">⚠️ Low Attendance (≤50%)</button>';
  html += '<button class="btn btn-warning" onclick="showAtRiskAbhyasis()">⚠️ At-Risk (25-50%)</button>';
  html += '<button class="btn btn-danger" onclick="showZeroAttendanceLastSixty()">🆘 Inactive (60+ days)</button>';
  html += '</div></div>';
  
  // Distribution
  html += '<div style="margin-bottom:20px;">';
  html += '<h4 style="color:#2c3e50; margin-bottom:12px;">📊 Distribution</h4>';
  html += '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">';
  html += '<button class="btn" onclick="showTrainerWiseDistribution()">🎓 Trainer-Wise Distribution</button>';
  html += '</div></div>';
  
  html += '</div>';
  
  results.innerHTML = html;
}
////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

// Save locally only (no cloud sync)
function saveDataLocal() {
  try {
    const data = { abhyasis, attendanceHistory, lastSaved: new Date().toISOString() };
    localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));
  } catch (err) {
    console.error('saveDataLocal error', err);
    showAlert('Failed to save data locally', 'error');
  }
}

//////////////////////////////////////////////////////////////////////////////////


/***** STORAGE: localStorage for abhyasis & attendanceHistory *****/
    function saveData() {
  try {
    const data = { abhyasis, attendanceHistory, lastSaved: new Date().toISOString() };
    localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));

    // 🔄 push changes to server too
    if (currentUser) {
      syncToServer().then(res => {
        if (!res || !res.success) console.warn('Server sync failed', res);
        else console.info('Server sync OK');
      });
    }
  } catch (err) {
    console.error('saveData error', err);
    showAlert('Failed to save data locally', 'error');
  }
}

/////////////////////////////////////////////////////////////////////////////

// Manual save to cloud for Manage Abhyasis
async function saveAbhyasisToCloud() {
  if (!currentUser) {
    showAlert('Not authenticated', 'error');
    return;
  }
  
  if (!abhyasis.length) {
    showAlert('No abhyasis to save', 'error');
    return;
  }
  
  showAlert('Saving abhyasi details to cloud...', 'info');
  
  saveDataLocal();
  const result = await syncToServer();
  
  if (result && result.success) {
    showAlert('✅ Successfully saved ' + abhyasis.length + ' abhyasi(s) to cloud!', 'success');
  } else {
    showAlert('❌ Failed to save to cloud: ' + (result?.error || 'Unknown error'), 'error');
  }
}

///////////////////////////////////////////////////////////////////////////
async function verifyAbhyasisDataOnLogin() {
  console.log('Verifying abhyasi data on login...');
  console.log('Current abhyasis count:', abhyasis.length);
  
  loadSavedData();
  console.log('After loading local data:', abhyasis.length, 'abhyasis');
  
  const cloudResult = await fetchFromServer();
  console.log('After cloud fetch:', abhyasis.length, 'abhyasis with data:');
  abhyasis.forEach(a => {
    console.log(`  - ${a.name} (${a.id}): Joined ${a.dateOfJoining || 'N/A'}`);
  });
}
/////////////////////////////////////////////////////////////////////////////////

    function loadSavedData() {
      try {
        const raw = localStorage.getItem(APP_DATA_KEY);
        if (!raw) { abhyasis = []; attendanceHistory = {}; return; }
        const obj = JSON.parse(raw);
        abhyasis = obj.abhyasis || [];
        attendanceHistory = obj.attendanceHistory || {};
        updateStudentsList();
        updateAttendanceList();
      } catch (err) { console.error('loadSavedData', err); abhyasis = []; attendanceHistory = {}; }
    }
    ///////////////////////////////////////////////////////////////////////////////////
// ---- CONFIG: update these ----
///////////////////////////////////////////////////////////////////////////////////
// ---- SUPABASE Configuration ----
const SUPABASE_URL = 'https://ldzarjlzzecqneofhirg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkemFyamx6emVjcW5lb2ZoaXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzEzNTQsImV4cCI6MjA3NTA0NzM1NH0.PmgjRhA8XIOlGmjDV-As5EHNjl4ctebD5FfgYOo1d2g';  // Paste your anon public key here

// Initialize Supabase
let supabase = null;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  console.log('Supabase initialized successfully');
} catch (err) {
  console.error('Supabase initialization error:', err);
}

// Sync to Supabase
async function syncToServer() {
  if (!currentUser) {
    console.warn('syncToServer: no currentUser');
    return { success: false, error: 'No user' };
  }
  
  if (!supabase) {
    console.warn('Supabase not initialized');
    return { success: false, error: 'Database not available' };
  }
  
  try {
    const payload = {
      user_email: currentUser,
      data: {
        abhyasis: abhyasis,
        attendanceHistory: attendanceHistory,
        masterRecords: masterRecords
      },
      updated_at: new Date().toISOString()
    };
    
    console.log('Syncing to Supabase for user:', currentUser);
    
    // Check if record exists
    const { data: existing, error: fetchError } = await supabase
      .from('meditation_data')
      .select('id')
      .eq('user_email', currentUser)
      .single();
    
    if (fetchError && fetchError.code !== 'PGRST116') {
      throw fetchError;
    }
    
    let result;
    if (existing) {
      // Update existing record
      result = await supabase
        .from('meditation_data')
        .update(payload)
        .eq('user_email', currentUser);
    } else {
      // Insert new record
      result = await supabase
        .from('meditation_data')
        .insert([payload]);
    }
    
    if (result.error) throw result.error;
    
    console.log('Sync successful - abhyasis, attendance, and master records saved');
    return { success: true };
    
  } catch (err) {
    console.error('syncToServer error:', err);
    showAlert('Sync failed: ' + err.message, 'error');
    return { success: false, error: String(err) };
  }
}

// Fetch from Supabase
async function fetchFromServer() {
  if (!currentUser) {
    console.warn('fetchFromServer: no currentUser');
    return { success: false, error: 'No user' };
  }
  
  if (!supabase) {
    console.warn('Supabase not initialized');
    return { success: false, error: 'Database not available' };
  }
  
  try {
    console.log('Fetching from Supabase for user:', currentUser);
    
    const { data, error } = await supabase
      .from('meditation_data')
      .select('data')
      .eq('user_email', currentUser)
      .single();
    
    if (error) {
      if (error.code === 'PGRST116') {
        console.info('No remote data found for', currentUser);
        return { success: true, found: false };
      }
      throw error;
    }
    
    if (!data || !data.data) {
      console.info('No remote data found for', currentUser);
      return { success: true, found: false };
    }
    
    const remote = data.data;
    console.log('Remote data retrieved');
    
    // ===== MERGE ABHYASIS (with dateOfJoining) =====
    if (remote.abhyasis && Array.isArray(remote.abhyasis)) {
      const localIds = new Set(abhyasis.map(a => a.id));
      let addedCount = 0;
      remote.abhyasis.forEach(r => {
        if (!localIds.has(r.id)) {
          abhyasis.push({
            name: r.name,
            id: r.id,
            contact: r.contact || '',
            dateOfJoining: r.dateOfJoining || ''
          });
          addedCount++;
        } else {
          const existing = abhyasis.find(a => a.id === r.id);
          if (existing && !existing.dateOfJoining && r.dateOfJoining) {
            existing.dateOfJoining = r.dateOfJoining;
          }
        }
      });
      console.log('Added', addedCount, 'new abhyasis');
    }
    
    // Merge attendanceHistory
    if (remote.attendanceHistory && typeof remote.attendanceHistory === 'object') {
      Object.keys(remote.attendanceHistory).forEach(d => {
        attendanceHistory[d] = remote.attendanceHistory[d];
      });
      console.log('Merged attendance history');
    }
    
    // Merge masterRecords
    if (remote.masterRecords && Array.isArray(remote.masterRecords)) {
      const beforeCount = masterRecords.length;
      masterRecords = masterRecords.concat(remote.masterRecords);
      masterRecords = removeDuplicateRecords(masterRecords);
      saveMasterRecords();
      console.log('Merged master records:', masterRecords.length - beforeCount, 'new');
    }
    
    saveDataLocal();
    displayAllRecords();
    updateStudentsList();
    updateAttendanceList();
    
    showAlert('Data synced from cloud (abhyasis with joining dates loaded)', 'success');
    return { success: true, merged: true };
    
  } catch (err) {
    console.error('fetchFromServer error:', err);
    showAlert('Fetch failed: ' + err.message, 'error');
    return { success: false, error: String(err) };
  }
}
/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
    function removeDuplicateRecords(records) {
      const seen = new Set();
      return records.filter(r => {
        const key = `${r.date}__${r.id}__${(r.sessionName||'')}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function escapeCSVField(field) {
      if (field == null) return '""';
      const str = String(field);
      if (str.includes('"')) return `"${str.replace(/"/g,'""')}"`;
      if (str.includes(',') || str.includes('\n')) return `"${str}"`;
      return `"${str}"`;
    }

    // CSV now includes Session Type as well: Date,Day of Week,Abhyasi Name,Abhyasi ID,Session Name,Session Type,Trainer,Present,Month,Year
    function buildMergedCSV(records) {
      let csv = 'Date,Day of Week,Abhyasi Name,Abhyasi ID,Session Name,Session Type,Trainer,Present,Month,Year\n';
      records.forEach(record => {
        const dateObj = new Date(record.date);
        let day='', month='', year='';
        if (!isNaN(dateObj.getTime())) {
          day = dateObj.toLocaleDateString('en-US', { weekday:'long' });
          month = dateObj.toLocaleDateString('en-US', { month:'long' });
          year = dateObj.getFullYear();
        }
        csv += `${escapeCSVField(record.date)},${escapeCSVField(day)},${escapeCSVField(record.name)},${escapeCSVField(record.id)},${escapeCSVField(record.sessionName)},${escapeCSVField(record.sessionType || '')},${escapeCSVField(record.trainer)},${record.present ? 'Yes' : 'No'},${escapeCSVField(month)},${escapeCSVField(year)}\n`;
      });
      return csv;
    }

    function parseCSVToRecords(csvContent) {
      if (!csvContent) return [];
      const lines = csvContent.split(/\r?\n/).filter(l => l.trim());
      if (lines.length <= 1) return [];
      const records = [];
      for (let i=1;i<lines.length;i++) {
        const cols = parseCSVLineAdvanced(lines[i]);
        if (!cols.length) continue;
        records.push({
          date: cols[0] || '',
          name: cols[2] || '',
          id: cols[3] || '',
          sessionName: cols[4] || '',
          sessionType: cols[5] || '',
          trainer: cols[6] || '',
          present: (cols[7] || '').toString().toLowerCase() === 'yes'
        });
      }
      return records.filter(r => r.date && r.name && r.id);
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"]/g, ch => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[ch]);
    }

    function showAlert(message, type='info') {
      const container = document.getElementById('alertContainer');
      const div = document.createElement('div');
      div.className = `alert ${type==='success' ? 'alert-success' : type==='error' ? 'alert-error' : 'alert-info'}`;
      div.textContent = message;
      container.appendChild(div);
      setTimeout(() => div.remove(), 4500);
    }

    function checkAuthentication() {
      if (!isAuthenticated || !AUTHORIZED_USERS[currentUser]) { logout(); return false; }
      return true;
    }

    /***** TAB SWITCHING *****/
    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabs = Array.from(document.querySelectorAll('.tab'));
      tabs.forEach(t => {
        if (t.textContent.toLowerCase().includes(name)) t.classList.add('active');
      });
      const target = document.getElementById(name + '-tab');
      if (target) target.classList.add('active');

      if (name === 'records') displayAllRecords();
      if (name === 'import') { /* nothing */ }
    }

    /***** Helper: clear attendanceHistory only (not master) *****/
    function clearAllRecords() {
      if (!confirm('Delete all attendanceHistory in app? This cannot be undone.')) return;
      attendanceHistory = {};
      saveData();
      displayAllRecords();
      showAlert('All attendanceHistory cleared', 'success');
    }

    /***** Mobile nav toggle behavior (open/close, outside-click, link close) *****/
    (function() {
      const menuToggle = document.getElementById('menu-toggle');
      const navMenu = document.getElementById('nav-menu');

      if (!menuToggle || !navMenu) return;

      // toggle menu open/close
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navMenu.classList.toggle('active');
        const expanded = navMenu.classList.contains('active');
        menuToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      });

      // close when a nav link is clicked (so the menu closes after choosing)
      document.querySelectorAll('#nav-menu a').forEach(a => {
        a.addEventListener('click', () => {
          navMenu.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        });
      });

      // close when clicking outside the menu (on small screens)
      document.addEventListener('click', (e) => {
        const isClickInside = navMenu.contains(e.target) || menuToggle.contains(e.target);
        if (!isClickInside) {
          navMenu.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });

      // close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          navMenu.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });
    })();

    ////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////

    /* =========================
   REPORTS — based on masterRecords (View All Records)
   ========================= */

// Show/hide student select on report type
document.getElementById('reportType').addEventListener('change', function () {
  const isStudent = this.value === 'student';
  document.getElementById('studentSelectGroup').style.display = isStudent ? 'block' : 'none';
  if (isStudent) updateStudentSelectFromMaster();
});

// Range mode toggle
function onRangeModeChange() {
  const mode = document.querySelector('input[name="rangeMode"]:checked').value;
  const showMonth = (mode === 'month');
  document.getElementById('monthRangeGroup').style.display = showMonth ? '' : 'none';
  document.getElementById('endMonthGroup').style.display = showMonth ? '' : 'none';
  document.getElementById('dateRangeGroup').style.display = showMonth ? 'none' : '';
  document.getElementById('dateRangeGroup2').style.display = showMonth ? 'none' : '';
}

// Build student dropdown from masterRecords
function updateStudentSelectFromMaster() {
  const sel = document.getElementById('reportStudent');
  if (!sel) return;
  const seen = new Map(); // id -> name
  (masterRecords || []).forEach(r => {
    if (r && r.id) {
      if (!seen.has(r.id)) seen.set(r.id, r.name || r.id);
    }
  });
  const options = ['<option value="">Select an Abhyasi</option>'];
  for (const [id, name] of seen.entries()) {
    options.push(`<option value="${escapeHtml(id)}">${escapeHtml(name)} (${escapeHtml(id)})</option>`);
  }
  sel.innerHTML = options.join('');
}

// Main generate
function generateReport() {
  if (!Array.isArray(masterRecords) || masterRecords.length === 0) {
    showAlert('No records in "View All Records" to report on.', 'error');
    return;
  }

  const mode = document.querySelector('input[name="rangeMode"]:checked').value;
  let start, end;
  if (mode === 'month') {
    const sm = document.getElementById('startMonth').value;
    const em = document.getElementById('endMonth').value;
    if (!sm || !em) { showAlert('Please select both start and end month', 'error'); return; }
    start = sm + '-01';
    // pick a generous end so string compare works for YYYY-MM-DD
    end = em + '-31';
    if (start > end) { showAlert('Start month must be <= end month', 'error'); return; }
  } else {
    const sd = document.getElementById('startDate').value;
    const ed = document.getElementById('endDate').value;
    if (!sd || !ed) { showAlert('Please select both start and end date', 'error'); return; }
    start = sd; end = ed;
    if (start > end) { showAlert('Start date must be <= end date', 'error'); return; }
  }

  const type = document.getElementById('reportType').value;
  const results = document.getElementById('reportResults');
  results.style.display = 'block';

  if (type === 'monthly') {
    generateMonthlyReportFromMaster(start, end, results);
  } else if (type === 'detailed') {
    generateDetailedReportFromMaster(start, end, results);
  } else if (type === 'student') {
    const sid = document.getElementById('reportStudent').value;
    if (!sid) { showAlert('Select Abhyasi', 'error'); return; }
    generateStudentReportFromMaster(start, end, sid, results);
  }
}

// Helper: filter masterRecords by date range, returns shallow copy
function getMasterInRange(start, end) {
  return (masterRecords || []).filter(r => r && r.date >= start && r.date <= end);
}

/* ---------- Monthly Summary (from master) ---------- */
function generateMonthlyReportFromMaster(start, end, container) {
  const rowsByDate = {};
  const inRange = getMasterInRange(start, end);
  if (!inRange.length) { container.innerHTML = '<p style="color:#666;">No records found</p>'; return; }

  const students = new Set();
  inRange.forEach(r => {
    const d = r.date;
    if (!rowsByDate[d]) rowsByDate[d] = { total: 0, present: 0 };
    rowsByDate[d].total += 1;
    if (r.present) rowsByDate[d].present += 1;
    if (r.id) students.add(r.id);
  });

  const dates = Object.keys(rowsByDate).sort();
  const totalClasses = dates.length;
  const totalAttendances = dates.reduce((acc, d) => acc + rowsByDate[d].present, 0);
  const avg = Math.round(totalAttendances / Math.max(1, totalClasses));

  let html = `<div>
    <h3>Summary (${start} → ${end})</h3>
    <div>Total classes: ${totalClasses} | Unique Abhyasis: ${students.size} | Avg attendance: ${avg}</div>
    <table class="report-table">
      <thead><tr><th>Date</th><th>Present</th><th>Total</th><th>Attendance %</th></tr></thead>
      <tbody>`;

  dates.forEach(d => {
    const { total, present } = rowsByDate[d];
    const pct = total ? Math.round((present / total) * 100) : 0;
    html += `<tr>
      <td>${new Date(d).toLocaleDateString()}</td>
      <td>${present}</td>
      <td>${total}</td>
      <td>${pct}%</td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
}

/* ---------- Detailed Records (from master) ---------- */
function generateDetailedReportFromMaster(start, end, container) {
  const inRange = getMasterInRange(start, end).sort((a,b) => a.date.localeCompare(b.date));
  if (!inRange.length) { container.innerHTML = '<p style="color:#666;">No records found</p>'; return; }

  // group by date
  const byDate = {};
  inRange.forEach(r => {
    if (!byDate[r.date]) byDate[r.date] = [];
    byDate[r.date].push(r);
  });

  const dates = Object.keys(byDate).sort();
  let html = `<div><h3>Detailed Report (${start} → ${end})</h3>`;
  dates.forEach(date => {
    const recs = byDate[date];
    const present = recs.filter(r => r.present).length;
    const sess = recs[0]?.sessionName || 'Session';
    const tr = recs[0]?.trainer || 'Not specified';
    const stype = recs[0]?.sessionType || '';
    html += `<div style="margin-bottom:12px;">
      <h4>${new Date(date).toLocaleDateString()}</h4>
      <div>${escapeHtml(sess)}${stype ? ' | ' + escapeHtml(stype) : ''} | ${escapeHtml(tr)} | Present: ${present}/${recs.length}</div>
      <table class="report-table">
        <thead><tr><th>#</th><th>Name</th><th>ID</th><th>Status</th></tr></thead><tbody>`;

    recs.forEach((r,i) => {
      html += `<tr>
        <td>${i+1}</td>
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.id)}</td>
        <td>${r.present ? 'Present' : 'Absent'}</td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
  });
  html += `</div>`;
  container.innerHTML = html;
}

/* ---------- Individual Abhyasi (from master) with Chart ---------- */
let reportsCurrentChart = null;

function generateStudentReportFromMaster(start, end, studentId, container) {
  const recs = getMasterInRange(start, end).filter(r => r.id === studentId);
  if (!recs.length) { container.innerHTML = '<p style="color:#666;">No records found for this Abhyasi in selected range.</p>'; return; }

  const presentCount = recs.filter(r => r.present).length;
  const rate = Math.round((presentCount / recs.length) * 100);
  // best-effort name
  const name = (recs.find(r => r.name)?.name) || studentId;

  let html = `<div>
    <h3>👤 ${escapeHtml(name)} — ${start} → ${end}</h3>
    <div style="margin-bottom:12px;">Total classes: ${recs.length} | Attended: ${presentCount} | Rate: ${rate}%</div>
    <div class="chart-controls">
      <label>Chart type:
        <select id="chartTypeSelect">
          <option value="bar">Bar</option>
          <option value="line">Line</option>
          <option value="pie">Pie</option>
        </select>
      </label>
      <label>Group by:
        <select id="chartGroupSelect">
          <option value="byDate">By Date (attendance)</option>
          <option value="bySession">By Session name</option>
        </select>
      </label>
      <button class="btn" id="renderChartBtn">Render Chart</button>
    </div>
    <div style="background:white; padding:12px; border-radius:8px;">
      <canvas id="studentChart" width="800" height="300"></canvas>
    </div>
  </div>`;

  container.innerHTML = html;

  document.getElementById('renderChartBtn').addEventListener('click', () => {
    const type = document.getElementById('chartTypeSelect').value;
    const group = document.getElementById('chartGroupSelect').value;
    renderStudentChartFromMaster(recs, type, group);
  });

  renderStudentChartFromMaster(recs, 'bar', 'byDate');
}

function renderStudentChartFromMaster(records, type, group) {
  const ctx = document.getElementById('studentChart').getContext('2d');
  if (reportsCurrentChart) { reportsCurrentChart.destroy(); reportsCurrentChart = null; }

  if (group === 'byDate') {
    const sorted = records.slice().sort((a,b) => a.date.localeCompare(b.date));
    const labels = sorted.map(r => new Date(r.date).toLocaleDateString());
    const data = sorted.map(r => r.present ? 1 : 0);
    const cfg = {
      type: type === 'pie' ? 'pie' : type,
      data: {
        labels,
        datasets: [{
          label: 'Presence (1=present,0=absent)',
          data,
          // keep default colors; Chart.js will assign
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: type === 'pie' } },
        scales: type === 'pie' ? undefined : { y: { beginAtZero:true, ticks:{ stepSize:1, precision:0 } } }
      }
    };
    reportsCurrentChart = new Chart(ctx, cfg);
  } else {
    // group by session name
    const groups = {};
    records.forEach(r => {
      const key = r.sessionName || 'Session';
      if (!groups[key]) groups[key] = { present:0, total:0 };
      groups[key].total++;
      if (r.present) groups[key].present++;
    });
    const labels = Object.keys(groups);
    const presentData = labels.map(l => groups[l].present);
    const cfg = {
      type: type === 'pie' ? 'pie' : type,
      data: {
        labels,
        datasets: [{ label: 'Present', data: presentData }]
      },
      options: { responsive:true, plugins: { legend:{ display: true } } }
    };
    reportsCurrentChart = new Chart(ctx, cfg);
  }
}



/* ---------- Small utilities used above ---------- */
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"]/g, ch => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[ch]);
}

// OPTIONAL: initialize defaults and ensure dropdown is ready when page loads
(function initReportsDefaults(){
  const now = new Date();
  const thisMonth = now.toISOString().slice(0,7);
  const sm = document.getElementById('startMonth');
  const em = document.getElementById('endMonth');
  const sd = document.getElementById('startDate');
  const ed = document.getElementById('endDate');
  if (sm && !sm.value) sm.value = thisMonth;
  if (em && !em.value) em.value = thisMonth;
  if (sd && !sd.value) sd.valueAsDate = new Date();
  if (ed && !ed.value) ed.valueAsDate = new Date();
  updateStudentSelectFromMaster();
})();

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////

    /***** Load & initial setup done at top *****/
    ////////////////Clean stale records////////////////////////////

    /***** CLEANUP STALE RECORDS *****/
function cleanupStaleRecords() {
  if (!masterRecords.length) {
    showAlert('No master records to clean', 'info');
    return;
  }

  // Get current valid abhyasi IDs from Manage Abhyasis
  const validIds = new Set(abhyasis.map(a => a.id));
  
  const beforeCount = masterRecords.length;
  
  // Filter out records for abhyasis that no longer exist
  masterRecords = masterRecords.filter(r => validIds.has(r.id));
  
  const afterCount = masterRecords.length;
  const removedCount = beforeCount - afterCount;
  
  if (removedCount === 0) {
    showAlert('✅ No stale records found. All records are valid!', 'success');
    return;
  }
  
  // Save cleaned records
  saveMasterRecords();
  
  // Update attendance history to remove stale records
  Object.keys(attendanceHistory).forEach(date => {
    attendanceHistory[date] = attendanceHistory[date].filter(r => validIds.has(r.id));
    if (attendanceHistory[date].length === 0) {
      delete attendanceHistory[date];
    }
  });
  
  saveData();
  displayAllRecords();
  
  showAlert(`🧹 Cleaned up ${removedCount} stale record(s). ${afterCount} valid records remain.`, 'success');
  
  // Show detailed report
  setTimeout(() => {
    if (confirm(`Cleanup complete!\n\nRemoved: ${removedCount} stale records\nRemaining: ${afterCount} valid records\n\nWould you like to see the updated records?`)) {
      switchTab('records');
      displayAllRecords();
    }
  }, 500);
}
/////////////////////////////////////////////////////////////////////////////////////////
  </script>

  </body>
</html>
